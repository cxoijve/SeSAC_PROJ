*&---------------------------------------------------------------------*
*&  Include           MZSSMM02F02
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  SET_DEFAULT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM set_default .

  " 공통변수 기본 값 설정
  PERFORM init_variables.

  " screen 기본 값 설정
  PERFORM set_default_values.

  " layout, fcat, sort 설정
  PERFORM set_screen_element.

  " 기본 데이터 가져오기 - search시에도 쓰임
  PERFORM get_datas.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INIT_VARIABLES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM init_variables .

  CLEAR : ok_code,
          gv_subrc,
          gv_msg.

  gv_radio_vname = 'X'.
  gv_radio_venid = ''.
  gv_radio_screen = 0.
  gv_screen = 0.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_DEFAULT_VALUES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM set_default_values .

  PERFORM set_date CHANGING zsssmm0210-grdat_s zsssmm0210-grdat_e zsssmm0210-dudat_s zsssmm0210-dudat_e zsssmm0214-grdat.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_DATE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_ZSSSMM0210_GRDAT_S  text
*      <--P_ZSSSMM0210_DUDAT_S  text
*      <--P_ZSSSMM0214_GRDAT  text
*----------------------------------------------------------------------*
FORM set_date  CHANGING cv_grdat_s TYPE sy-datum
                        cv_grdat_e TYPE sy-datum
                        cv_dudat_s TYPE sy-datum
                        cv_dudat_e TYPE sy-datum
                        cv_grdoc TYPE sy-datum.

  " 입고일자 : 이번달 첫째일 ~ 이번달 말일
  cv_grdat_s = sy-datum+0(6) && '01'.
  PERFORM cal_last_day_month USING sy-datum CHANGING cv_grdat_e.

  " 납기일자 설정 : 오늘 기준 7일전 ~ 오늘 기준 30일 후
  PERFORM cal_date_in_interval USING sy-datum  7 0 0 '-' CHANGING cv_dudat_s.
  PERFORM cal_date_in_interval USING sy-datum  30 0 0 '+' CHANGING cv_dudat_e.

  " 입고시점 날짜 설정
  cv_grdoc = sy-datum.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_SCREEN_ELEMENT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM set_screen_element .

  PERFORM set_exclude_btn.
  PERFORM set_layouts.
  PERFORM set_field_catalogs.
*  perform set_sorts.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_LAYOUTS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM set_layouts .

  " title -> into_fname -> zebra -> no_rowins -> excp_fname -> excp_led -> ctab_fname -> edit
*  PERFORM set_layout USING '입고 대기 리스트' 'COLOR' abap_true abap_false 'EXCP' abap_false '' abap_false CHANGING gs_layo.
*  PERFORM set_layout USING '입고 가능 구매오더 아이템' 'COLOR' abap_true abap_false '' abap_false '' abap_false CHANGING gs_layo2.
*  PERFORM set_layout USING '입고 확정 구매오더 아이템' 'COLOR' abap_true abap_false '' abap_false '' abap_false CHANGING gs_layo3.


  gs_layo = lcl_layout_builder=>create(
    iv_title      = '입고 대기 구매오더 리스트'
    iv_info_fname = 'COLOR'
    iv_zebra      = abap_true
    iv_excp_fname = 'LIGHT'
    iv_excp_led   = abap_true
    iv_ctab_fname = 'IT_COL' ).


  gs_layo2 = lcl_layout_builder=>create(
      iv_title     = '입고 가능 구매오더 아이템'
      iv_no_rowins = abap_true
      iv_ctab_fname = 'IT_COL' ).

  gs_layo2-stylefname = 'STYLE'.


  gs_layo3 = lcl_layout_builder=>create(
      iv_title     = '입고 확정 구매오더 아이템'
      iv_no_rowins = abap_true
      iv_ctab_fname = 'IT_COL' ).


  gs_layo5 = lcl_layout_builder=>create(
     iv_title     = '입고 완료 리스트'
     iv_info_fname = 'COLOR'
*       iv_excp_fname = 'LIGHT'
     iv_ctab_fname = 'IT_COL'
     iv_no_rowins = abap_true ).
*  gs_layo-cwidth_opt =

  gs_layo6 = lcl_layout_builder=>create(
     iv_title     = '입고 아이템 리스트'
     iv_info_fname = 'COLOR'
     iv_zebra = abap_true
     iv_ctab_fname = 'IT_COL'
     iv_no_rowins = abap_true ).

  gs_layo7 = lcl_layout_builder=>create(
       iv_title     = '편집 가능 입고아이템 리스트'
       iv_info_fname = 'COLOR'
       iv_zebra = abap_true
       iv_no_rowins = abap_true ).

  gs_layo8 = lcl_layout_builder=>create(
       iv_title     = '구매오더 아이템 리스트'
       iv_info_fname = 'COLOR'
       iv_zebra = abap_true
       iv_no_rowins = abap_true ).


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_LAYOUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_0107   text
*      -->P_0108   text
*      -->P_ABAP_TRUE  text
*      -->P_ABAP_FALSE  text
*      -->P_0111   text
*      -->P_ABAP_FALSE  text
*      -->P_0113   text
*      -->P_ABAP_FALSE  text
*      <--P_GS_LAYO  text
*----------------------------------------------------------------------*
FORM set_layout  USING    pv_title      TYPE lvc_title
                          pv_info_fname TYPE lvc_fname
                          pv_zebra      TYPE abap_bool
                          pv_no_rowins  TYPE abap_bool
                          pv_excp_fname TYPE lvc_fname
                          pv_excp_led   TYPE abap_bool
                          pv_ctab_fname TYPE lvc_fname
                          pv_edit       TYPE abap_bool
                        CHANGING
                          cs_layo       TYPE lvc_s_layo.


  CLEAR cs_layo.

  " 기본 설정
  cs_layo-cwidth_opt = 'X'.
  cs_layo-sel_mode   = 'A'.
  cs_layo-col_opt    = 'X'.
  cs_layo-grid_title = pv_title.

  " 선택적 설정
  cs_layo-zebra     = COND #( WHEN pv_zebra = abap_true THEN 'X' ).
  cs_layo-no_rowins = COND #( WHEN pv_no_rowins = abap_true THEN 'X' ).
  cs_layo-edit      = COND #( WHEN pv_edit = abap_true THEN 'X' ).
  cs_layo-excp_led  = COND #( WHEN pv_excp_led = abap_true THEN 'X' ).

  IF pv_info_fname IS NOT INITIAL.
    cs_layo-info_fname = pv_info_fname.
  ENDIF.

  IF pv_ctab_fname IS NOT INITIAL.
    cs_layo-ctab_fname = pv_ctab_fname.
  ENDIF.

  IF pv_excp_fname IS NOT INITIAL.
    cs_layo-excp_fname = pv_excp_fname.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_FIELD_CATALOGS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM set_field_catalogs .

  DATA ls_fcat TYPE lvc_s_fcat.


  PERFORM create_fcat USING 'ZSSSMM0212' 'GT_PODATA' CHANGING gt_fcat.
  PERFORM set_fcat_no_out USING 'VENID' CHANGING gt_fcat.
  PERFORM set_fcat_no_out USING 'RGTOR' CHANGING gt_fcat.
*  PERFORM set_fcat_fieldname USING 'LIGHT' '입고상태'(t01) CHANGING gt_fcat.
  PERFORM set_priority_fcat CHANGING gt_fcat.
  PERFORM create_fcat USING 'ZSSSMM0213' 'GT_ITEM' CHANGING gt_fcat2.
  PERFORM create_fcat USING 'ZSSSMM0213' 'GT_CONFIRM' CHANGING gt_fcat3.
  PERFORM create_fcat USING 'ZSSSMM0211' 'GT_GRDATA' CHANGING gt_fcat5.
  PERFORM add_custom_fields CHANGING gt_fcat.
  PERFORM set_fcat_no_out USING 'STYLE' CHANGING gt_fcat2.

  " 데이터 레벨에서 행마다 다르게 설정





ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_FCAT_NO_OUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_0252   text
*      <--P_GT_FCAT  text
*----------------------------------------------------------------------*
FORM set_fcat_no_out  USING    VALUE(pv_val) TYPE lvc_fname
                      CHANGING ct_fcat TYPE lvc_t_fcat.

  FIELD-SYMBOLS: <fs_fcat> TYPE lvc_s_fcat.

  LOOP AT ct_fcat ASSIGNING <fs_fcat> WHERE fieldname = pv_val.

    <fs_fcat>-no_out = 'X'.
    <fs_fcat>-tech   = 'X'.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_PRIORITY_FCAT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_FCAT  text
*----------------------------------------------------------------------*
FORM set_priority_fcat  CHANGING ct_fcat TYPE lvc_t_fcat.

  DATA : ls_fcat_dudat TYPE lvc_s_fcat,
         ls_fcat_ven   TYPE lvc_s_fcat,
         lv_pos        TYPE i VALUE 1,
         lv_has_dudat  TYPE abap_bool,
         lv_has_ven    TYPE abap_bool.

  DATA : ls_cond TYPE zsssmm0210.

  MOVE-CORRESPONDING zsssmm0210 TO ls_cond.

  IF ls_cond-dudat_s IS NOT INITIAL AND ls_cond-venid IS INITIAL.
    lv_has_dudat = abap_true.

  ELSEIF ls_cond-dudat_s IS INITIAL AND ls_cond-venid IS NOT INITIAL.
    lv_has_ven = abap_true.
  ELSE.
    lv_has_dudat = abap_true.
  ENDIF.

  " 필드 카탈로그에서 대상 컬럼 찾기
  READ TABLE ct_fcat INTO ls_fcat_dudat WITH KEY fieldname = 'DUDAT'.
  READ TABLE ct_fcat INTO ls_fcat_ven   WITH KEY fieldname = 'VNAME'.

  " 우선순위 결정
  IF lv_has_dudat = abap_true AND lv_has_ven = abap_false.
    ls_fcat_dudat-col_pos = 1.
    ls_fcat_ven-col_pos   = 2.

  ELSEIF lv_has_dudat = abap_false AND lv_has_ven = abap_true.
    ls_fcat_ven-col_pos   = 1.
    ls_fcat_dudat-col_pos = 2.

  ELSE.
    ls_fcat_dudat-col_pos = 1.
    ls_fcat_ven-col_pos   = 2.
  ENDIF.

  " 변경사항 반영
  MODIFY ct_fcat FROM ls_fcat_dudat TRANSPORTING col_pos WHERE fieldname = 'DUDAT'.
  MODIFY ct_fcat FROM ls_fcat_ven   TRANSPORTING col_pos WHERE fieldname = 'VNAME'.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_DATAS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_datas .



  PERFORM get_po_datas USING zsssmm0210.

  PERFORM get_gr_datas USING zsssmm0210.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_PO_DATAS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM get_po_datas USING VALUE(p_cond) TYPE zsssmm0210.

*  data : lv_where type string.
  " 납기일, 벤더명 기준
  IF zsssmm0210-ponum IS NOT INITIAL.
    WRITE : zsssmm0210-ponum.
    CLEAR gt_podata.
    SELECT SINGLE ponum podat venid dudat stext rgtor
      INTO CORRESPONDING FIELDS OF gs_podata
      FROM ztsspoh
      WHERE ponum = zsssmm0210-ponum.
    APPEND gs_podata TO gt_podata.
    PERFORM modify_po_datas TABLES gt_podata.
    RETURN.
  ENDIF.

  PERFORM set_range_dudat USING p_cond-dudat_s p_cond-dudat_e CHANGING gr_dudat.
  PERFORM calulate_data USING p_cond.

  PERFORM modify_po_datas TABLES gt_podata.

  SORT gt_podata BY dudat ASCENDING.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_RANGE_DUDAT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_COND_DUDAT_S  text
*      -->P_P_COND_DUDAT_E  text
*      <--P_GR_DUDAT  text
*----------------------------------------------------------------------*
FORM set_range_dudat  USING    VALUE(pv_start) TYPE sy-datum
                               VALUE(pv_end) TYPE sy-datum
                      CHANGING cv_range LIKE gr_grdat.

  CLEAR cv_range.

  IF pv_start IS NOT INITIAL AND pv_end IS NOT INITIAL.
    cv_range = VALUE #( ( sign = 'I' option = 'BT' low = pv_start high = pv_end ) ).
  ELSEIF pv_start IS NOT INITIAL.
    cv_range = VALUE #( ( sign = 'I' option = 'EQ' low = pv_start  ) ).
  ELSEIF pv_end IS NOT INITIAL.
    cv_range = VALUE #( ( sign = 'I' option = 'LE' low = pv_end ) ).
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CALULATE_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM calulate_data USING VALUE(p_cond) TYPE zsssmm0210.

  DATA : lt_po_sum LIKE TABLE OF gs_itamt,
         lt_gr_sum LIKE TABLE OF gs_itamt.


  CLEAR gt_podata.

  PERFORM get_po_sum CHANGING lt_po_sum.
  PERFORM get_gr_sum CHANGING lt_gr_sum.

*  PERFORM cal_po_sum USING p_cond CHANGING lt_po_sum.
*  PERFORM cal_gr_sum USING lt_po_sum CHANGING lt_gr_sum.
  PERFORM create_po_list USING  lt_po_sum lt_gr_sum CHANGING gt_podata.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CAL_PO_SUM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_LT_PO_SUM  text
*----------------------------------------------------------------------*
FORM cal_po_sum   USING VALUE(p_cond) TYPE zsssmm0210
                  CHANGING ct_psum LIKE gt_itamt.

  DATA : lt_po_raw TYPE STANDARD TABLE OF ztsspoi,
         ls_po_raw LIKE LINE OF lt_po_raw,
         ls_po_sum LIKE gs_itamt,
         lv_where  TYPE string,
         lv_venid  TYPE ztssvend-venid.

  PERFORM set_where_cond USING p_cond CHANGING lv_venid lv_where.

  SELECT i~ponum i~itnum i~amount
    INTO CORRESPONDING FIELDS OF TABLE lt_po_raw
    FROM ztsspoi AS i
    INNER JOIN ztsspoh AS h
    ON i~ponum = h~ponum
    WHERE (lv_where)
    AND dudat IN gr_dudat.

  IF sy-subrc <> 0. RETURN. ENDIF.

  LOOP AT lt_po_raw INTO ls_po_raw.
    ls_po_sum-ponum  = ls_po_raw-ponum.
    ls_po_sum-itnum  = ls_po_raw-itnum.
    ls_po_sum-amount = ls_po_raw-amount.
    COLLECT ls_po_sum INTO ct_psum.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_WHERE_COND
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_COND  text
*      <--P_LV_WHERE  text
*----------------------------------------------------------------------*
FORM set_where_cond  USING VALUE(p_cond) TYPE zsssmm0210
                     CHANGING cv_venid TYPE ztssvend-venid
                              cv_where TYPE string.

  DATA : lv_venid TYPE ztssvend-venid.

  CLEAR : cv_where,
          lv_venid.

  IF p_cond-venid IS NOT INITIAL.
    lv_venid = p_cond-venid.
    CLEAR p_cond-vname.
    cv_where = 'VENID eq LV_VENID'.
  ELSEIF p_cond-vname IS NOT INITIAL.
    PERFORM get_vendor_id USING p_cond-vname CHANGING lv_venid.
    cv_where = 'VENID eq LV_VENID'.
  ELSE.
    CLEAR zsssmm0210.
  ENDIF.
  cv_venid = lv_venid.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CAL_GR_SUM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_COND  text
*      -->P_LT_PO_SUM  text
*      <--P_LT_GR_SUM  text
*----------------------------------------------------------------------*
FORM cal_gr_sum  USING pt_psum LIKE gt_itamt
                 CHANGING ct_gsum LIKE gt_itamt.

  DATA : lt_gr_raw TYPE STANDARD TABLE OF ztssgri,
         ls_gr_raw LIKE LINE OF lt_gr_raw,
         ls_gr_sum LIKE gs_itamt.

  IF pt_psum IS NOT INITIAL.
    SELECT ponum itnum amount
      INTO CORRESPONDING FIELDS OF TABLE lt_gr_raw
      FROM ztssgri
      FOR ALL ENTRIES IN pt_psum
      WHERE ponum = pt_psum-ponum
      AND itnum = pt_psum-itnum.
    IF sy-subrc = 0.
      LOOP AT lt_gr_raw INTO ls_gr_raw.
        ls_gr_sum-ponum  = ls_gr_raw-ponum.
        ls_gr_sum-itnum  = ls_gr_raw-itnum.
        ls_gr_sum-amount = ls_gr_raw-amount.
        COLLECT ls_gr_sum INTO ct_gsum.
      ENDLOOP.
    ENDIF.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CREATE_PO_LIST
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_PO_SUM  text
*      -->P_LT_GR_SUM  text
*      <--P_GT_PODATA  text
*----------------------------------------------------------------------*
FORM create_po_list  USING    pt_po_sum LIKE gt_itamt
                              pt_gr_sum LIKE gt_itamt
                     CHANGING ct_podata LIKE gt_podata.


*  DATA : ls_po_sum    LIKE gs_itamt,
*         ls_gr_sum    LIKE gs_itamt,
*         ls_podata    LIKE LINE OF gt_podata,
*         lt_po_header TYPE TABLE OF ztsspoh,
*         ls_po_header LIKE LINE OF lt_po_header,
*         lt_unique_po LIKE pt_po_sum.
*
*  IF pt_po_sum IS INITIAL. RETURN. ENDIF.
*
*  PERFORM get_po_headers USING pt_po_sum CHANGING lt_po_header.
*  IF lt_po_header IS INITIAL. RETURN. ENDIF.
*
*  PERFORM get_po_items USING pt_po_sum
*                             pt_gr_sum
*                             lt_po_header
*                       CHANGING ct_podata.

  DATA: ls_po_sum LIKE gs_itamt,
        ls_gr_sum LIKE gs_itamt,
        ls_po     LIKE LINE OF gt_podata,
        lv_where  TYPE string,
        lv_venid  TYPE ztssvend-venid.

  CLEAR : lv_where, lv_venid.

  PERFORM set_where_cond USING zsssmm0210 CHANGING lv_venid lv_where.
  WRITE : zsssmm0210.
*  CONCATENATE lv_where
*            ' AND ponum = ''' ls_po_sum-ponum ''''
*            ' AND dudat IN gr_dudat'
*  INTO lv_where SEPARATED BY space.

  WRITE : lv_where.
  LOOP AT pt_po_sum INTO ls_po_sum.

    " PO 헤더정보
    CLEAR ls_po.

    SELECT SINGLE ponum podat venid dudat stext rgtor
      INTO CORRESPONDING FIELDS OF ls_po
      FROM ztsspoh
      WHERE ponum = ls_po_sum-ponum
      AND dudat IN gr_dudat
      AND (lv_where).


    CHECK sy-subrc = 0.

    READ TABLE pt_gr_sum INTO ls_gr_sum WITH KEY ponum = ls_po_sum-ponum
                                                 itnum = ls_po_sum-itnum.

    IF sy-subrc <> 0.
      ls_po-light = '1'.
    ELSEIF ls_gr_sum-amount < ls_po_sum-amount.
      ls_po-light = '2'.
    ELSEIF ls_gr_sum-amount = ls_po_sum-amount.
      ls_po-light = '3'.
    ENDIF.

    IF sy-subrc <> 0.
      " 입고대기
*      ls_po-light = '1'.
      READ TABLE ct_podata TRANSPORTING NO FIELDS
        WITH KEY ponum = ls_po_sum-ponum.
      IF sy-subrc <> 0.
        APPEND ls_po TO ct_podata.
      ENDIF.
    ELSEIF ls_gr_sum-amount < ls_po_sum-amount.
      " 부분입고
*      ls_po-light = '2'.

      " 데이터를 찾기만하는 로직 - 데이터를 찾기만함!** 여쭤볼것  (기존에는 필드를 찾아서 모두 스트럭쳐에 담아뒀음)
      READ TABLE ct_podata TRANSPORTING NO FIELDS
        WITH KEY ponum = ls_po_sum-ponum.
      IF sy-subrc <> 0.
        APPEND ls_po TO ct_podata.
      ENDIF.
    ENDIF.


*    READ TABLE pt_gr_sum INTO ls_gr_sum
*      WITH KEY ponum = ls_po_sum-ponum
*               itnum = ls_po_sum-itnum.
*
*    IF sy-subrc <> 0.
*      ls_po-light = '1'.  " 입고대기
*      ls_po-itnum = ls_po_sum-itnum.  " 아이템 번호도 저장!
*
*      READ TABLE ct_podata TRANSPORTING NO FIELDS
*        WITH KEY ponum = ls_po_sum-ponum
*                 itnum = ls_po_sum-itnum.  " ← itnum도 체크!
*      IF sy-subrc <> 0.
*        APPEND ls_po TO ct_podata.
*      ENDIF.
*
*    ELSEIF ls_gr_sum-amount < ls_po_sum-amount.
*      ls_po-light = '2'.  " 부분입고
*      ls_po-itnum = ls_po_sum-itnum.
*
*      READ TABLE ct_podata TRANSPORTING NO FIELDS
*        WITH KEY ponum = ls_po_sum-ponum
*                 itnum = ls_po_sum-itnum.  " ← itnum도 체크!
*      IF sy-subrc <> 0.
*        APPEND ls_po TO ct_podata.
*      ENDIF.
*
*    ELSEIF ls_gr_sum-amount = ls_po_sum-amount.
*      ls_po-light = '3'.  " 입고완료
*      ls_po-itnum = ls_po_sum-itnum.
*
*      READ TABLE ct_podata TRANSPORTING NO FIELDS
*        WITH KEY ponum = ls_po_sum-ponum
*                 itnum = ls_po_sum-itnum.
*      IF sy-subrc <> 0.
*        APPEND ls_po TO ct_podata.
*      ENDIF.
*    ENDIF.
  ENDLOOP.



ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_PO_HEADERS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_PT_PO_SUM  text
*      <--P_LT_PO_HEADER  text
*----------------------------------------------------------------------*
FORM get_po_headers  USING    pt_po_sum        LIKE gt_itamt
                     CHANGING ct_po_header LIKE gt_po_header.

  DATA: lt_unique_po LIKE pt_po_sum.

  lt_unique_po = pt_po_sum.
  SORT lt_unique_po BY ponum.
  DELETE ADJACENT DUPLICATES FROM lt_unique_po COMPARING ponum.

  SELECT ponum podat venid dudat stext rgtor
    INTO CORRESPONDING FIELDS OF TABLE ct_po_header
    FROM ztsspoh
    FOR ALL ENTRIES IN lt_unique_po
    WHERE ponum = lt_unique_po-ponum
      AND dudat IN gr_dudat.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_PO_ITEMS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_PT_PO_SUM  text
*      -->P_PT_GR_SUM  text
*      -->P_LT_PO_HEADER  text
*      <--P_CT_PODATA  text
*----------------------------------------------------------------------*
FORM get_po_items  USING    pt_po_sum    LIKE gt_itamt
                            pt_gr_sum    LIKE gt_itamt
                            pt_po_header LIKE gt_po_header
                  CHANGING  ct_podata    LIKE gt_podata.

  DATA : ls_po_sum LIKE gs_itamt.

  LOOP AT pt_po_sum INTO ls_po_sum.
    PERFORM get_read_po_items USING  ls_po_sum
                                     pt_gr_sum
                                     pt_po_header
                            CHANGING ct_podata.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_READ_PO_ITEMS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_PO_SUM  text
*      -->P_PT_GR_SUM  text
*      -->P_PT_PO_HEADER  text
*      <--P_CT_PODATA  text
*----------------------------------------------------------------------*
FORM get_read_po_items  USING ps_po_sum    LIKE gs_itamt
                              pt_gr_sum    LIKE gt_itamt
                              pt_po_header LIKE gt_po_header
                     CHANGING ct_podata    LIKE gt_podata.

  DATA: ls_po_header TYPE ztsspoh,
        ls_gr_sum    LIKE gs_itamt,
        ls_po_sum    LIKE gs_itamt,
        ls_podata    LIKE LINE OF gt_podata.

  " 1. 헤더정보 찾기
  READ TABLE pt_po_header INTO ls_po_header WITH KEY ponum = ps_po_sum-ponum.
  IF sy-subrc <> 0. RETURN. ENDIF.

  " 2. 헤더 정보 복사
  MOVE-CORRESPONDING ls_po_header TO ls_podata.

  " 3. GR 조회
  READ TABLE pt_gr_sum INTO ls_gr_sum WITH KEY ponum = ps_po_sum-ponum
                                               itnum = ps_po_sum-itnum.

  " 4. 입고대기 / 부분입고 처리해주기
  IF sy-subrc <> 0.
    ls_podata-light = '1'.  " 입고대기
    READ TABLE ct_podata TRANSPORTING NO FIELDS
        WITH KEY ponum = ps_po_sum-ponum.
    IF sy-subrc <> 0.
      APPEND ls_podata TO ct_podata.
    ENDIF.
  ELSEIF ls_gr_sum-amount < ps_po_sum-amount.
    ls_podata-light = '2'.  " 부분입고
    READ TABLE ct_podata TRANSPORTING NO FIELDS WITH KEY ponum = ps_po_sum-ponum.
    IF sy-subrc <> 0.
      APPEND ls_podata TO ct_podata.
    ENDIF.
  ELSE.
    RETURN.
  ENDIF.

  " 5. 중복 체크 & 추가2



ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  MODIFY_PO_DATAS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GT_PODATA  text
*----------------------------------------------------------------------*
FORM modify_po_datas  TABLES t_data STRUCTURE gs_podata.

  LOOP AT t_data.
    PERFORM set_display_dudat_status USING t_data-dudat CHANGING t_data-light t_data.
*    PERFORM get_venid_name USING t_data-venid CHANGING t_data-vname.
    PERFORM get_vendor_name USING t_data-venid CHANGING t_data-vname.
    PERFORM get_emp_name USING t_data-rgtor CHANGING t_data-ename.

    MODIFY t_data.
    CLEAR t_data.
  ENDLOOP.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_DISPLAY_DUDAT_STATUS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_DATA_DUDAT  text
*      <--P_T_DATA_LIGHT  text
*      <--P_T_DATA  text
*----------------------------------------------------------------------*
FORM set_display_dudat_status  USING VALUE(pv_dudat) TYPE ztsspoh-dudat
                               CHANGING cv_light
                                          cs_data LIKE gs_podata.
  " 당일이라면 빨간색, 10일 이내라면 511색

  DATA : lv_dudat     TYPE ztsspoh-dudat,
         lv_dudat_ten TYPE sy-datum.
  DATA ls_col TYPE lvc_s_scol.

  lv_dudat = sy-datum.
  lv_dudat_ten = sy-datum + 10.

  IF pv_dudat < lv_dudat.
*    cv_light = '1'.
*    ls_col-fname = 'DUDAT'.
*    ls_col-color-col = '6'.
*    ls_col-color-int = '1'.
*    ls_col-color-inv = '0'.
*    APPEND ls_col TO cs_data-it_col.
    CLEAR ls_col.
  ELSEIF pv_dudat < lv_dudat_ten.
*    cv_light = '2'.
*    ls_col-fname = 'DUDAT'.
*    ls_col-color-col = '5'.
*    ls_col-color-int = '1'.
*    ls_col-color-inv = '1'.
*    APPEND ls_col TO cs_data-it_col.
    CLEAR ls_col.
  ELSE.
    cv_light = '3'.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_GR_DATAS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ZSSSMM0210  text
*----------------------------------------------------------------------*
FORM get_gr_datas  USING VALUE(p_cond) TYPE zsssmm0210.

  PERFORM set_range_grdat USING p_cond-grdat_s p_cond-grdat_e CHANGING gr_grdat.

  PERFORM get_grdatas USING p_cond.

  PERFORM modify_grdatas TABLES gt_grdata.

  SORT gt_grdata BY rgdat DESCENDING.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_RANGE_GRDAT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_COND_GRDAT_S  text
*      -->P_P_COND_GRDAT_E  text
*      <--P_GR_GRDAT  text
*----------------------------------------------------------------------*
FORM set_range_grdat   USING    VALUE(pv_start) TYPE sy-datum
                                VALUE(pv_end) TYPE sy-datum
                       CHANGING cv_range LIKE gr_grdat.


  CLEAR cv_range.

  IF pv_start IS NOT INITIAL AND pv_end IS NOT INITIAL.
    cv_range = VALUE #( ( sign = 'I' option = 'BT' low = pv_start high = pv_end ) ).
  ELSEIF pv_start IS NOT INITIAL.
    cv_range = VALUE #( ( sign = 'I' option = 'EQ' low = pv_start  ) ).
  ELSEIF pv_end IS NOT INITIAL.
    cv_range = VALUE #( ( sign = 'I' option = 'LE' low = pv_end ) ).
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_GRDATAS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_P_COND  text
*----------------------------------------------------------------------*
FORM get_grdatas  USING VALUE(p_cond) TYPE zsssmm0210.

  DATA : lv_where TYPE string,
         lv_venid TYPE ztssvend-venid.

  PERFORM set_where_cond USING p_cond CHANGING lv_venid lv_where.

  SELECT grnum rstat grdat jenum fyear stext rgdat rgtor
   INTO CORRESPONDING FIELDS OF TABLE gt_grdata
   FROM ztssgrh
   WHERE (lv_where)
   AND grdat IN gr_grdat.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  MODIFY_GRDATAS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GT_GRDATA  text
*----------------------------------------------------------------------*
FORM modify_grdatas  TABLES t_data STRUCTURE gs_grdata.

  LOOP AT t_data.
    PERFORM set_curr_status USING t_data-rstat CHANGING t_data t_data-rstat_t.
    PERFORM get_vendor_info USING t_data-grnum CHANGING t_data-venid.
    PERFORM get_vendor_name USING t_data-venid CHANGING t_data-vname.
    PERFORM get_emp_name USING t_data-rgtor CHANGING  t_data-ename.

    MODIFY t_data.
    CLEAR t_data.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_CURR_STATUS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_DATA_RSTAT  text
*      <--P_T_DATA  text
*      <--P_T_DATA_RSTAT_T  text
*----------------------------------------------------------------------*
FORM set_curr_status  USING pv_status TYPE ztssgrh-rstat
                     CHANGING cs_data LIKE gs_grdata
                              cv_status TYPE zsssmm0211-rstat_t.

  DATA : lv_check.

  PERFORM check_iv_status USING cs_data-grnum CHANGING cs_data lv_check.

  IF lv_check = '1'.
    cv_status = '송장검증완료'.
    cs_data-color = 'C501'.
    cs_data-ltext = icon_print.
  ELSEIF pv_status = 'A'.
    cv_status = '입고완료'.
    cs_data-ltext = icon_display_text.
  ELSEIF pv_status IS INITIAL.
    cv_status = '입고중'.
    cs_data-color = 'C601'.
    cs_data-ltext = icon_display_text.
  ELSE.
    cv_status = '알 수 없음'.
    cs_data-color = 'C201'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_VENDOR_INFO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_DATA_GRNUM  text
*      <--P_T_DATA_VENID  text
*----------------------------------------------------------------------*
FORM get_vendor_info  USING p_grnum TYPE ztssgrh-grnum
                      CHANGING c_venid TYPE ztssvend-venid.

  DATA : lv_ponum TYPE ztssgri-ponum.

  SELECT SINGLE ponum
  INTO lv_ponum
    FROM ztssgri
    WHERE grnum = p_grnum.


  SELECT SINGLE venid
    INTO c_venid
    FROM ztsspoh
    WHERE ponum = lv_ponum.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_IV_STATUS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_CS_DATA_GRNUM  text
*      <--P_CS_DATA  text
*      <--P_LV_CHECK  text
*----------------------------------------------------------------------*
FORM check_iv_status  USING    VALUE(p_grnum) TYPE ztssgrh-grnum
                      CHANGING cs_data LIKE gs_grdata
                               cv_check TYPE c.

  DATA : lv_ivnum TYPE ztssmivh-ivnum.

  CLEAR cv_check.

  SELECT SINGLE ivnum
      INTO lv_ivnum
      FROM ztssmivi
      WHERE grnum = p_grnum.

  IF sy-subrc = 0.
    cv_check = '1'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_FCAT_FIELDNAME
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_0295   text
*      -->P_0296   text
*      <--P_GT_FCAT  text
*----------------------------------------------------------------------*
FORM set_fcat_fieldname  USING    VALUE(pv_fieldname) TYPE lvc_fname
                                  VALUE(pv_text)      TYPE lvc_txtcol
                        CHANGING ct_fcat      TYPE lvc_t_fcat.
  FIELD-SYMBOLS: <fs_fcat> TYPE lvc_s_fcat.

  LOOP AT ct_fcat ASSIGNING <fs_fcat> WHERE fieldname = pv_fieldname.
    <fs_fcat>-coltext = pv_text.
    EXIT.
  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  ADD_CUSTOM_FIELDS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_FCAT  text
*----------------------------------------------------------------------*
FORM add_custom_fields  CHANGING ct_fcat TYPE lvc_t_fcat.
*  DATA: ls_fcat TYPE lvc_s_fcat.

*  " LIGHT 필드 추가
*  CLEAR ls_fcat.
*  ls_fcat-fieldname = 'LIGHT'.
*  ls_fcat-coltext   = '상태'.
*  ls_fcat-scrtext_s = '상태'.
*  ls_fcat-scrtext_m = '입고상태'.
*  ls_fcat-scrtext_l = '입고상태'.
*  ls_fcat-icon      = 'X'.
*  ls_fcat-just      = 'C'.
*  ls_fcat-outputlen = 8.
*  ls_fcat-col_pos   = 5.
*  INSERT ls_fcat INTO ct_fcat INDEX 1.
  TYPES : BEGIN OF ty_field_conf,
            grid_id    TYPE c LENGTH 2,
            fieldname  TYPE lvc_fname,
            coltext    TYPE scrtext_l,
            scrtext_s  TYPE scrtext_s,     " 짧은 텍스트
            scrtext_m  TYPE scrtext_m,     " 중간 텍스트
            scrtext_l  TYPE scrtext_l,     " 긴 텍스트
            outputlen  TYPE lvc_outlen,    " 컬럼 너비
            icon       TYPE c,             " 아이콘 여부
            just       TYPE lvc_just,      " 정렬 (L/C/R)
            emphasize  TYPE lvc_emphsz,    " 강조 색상
            key        TYPE c,             " 키 필드 여부
            intlen     TYPE i,  " ← 추가
            fix_column TYPE c,           " ← 추가
            no_out     TYPE c,             " 숨김
            edit       TYPE c,             " 편집 가능
            hotspot    TYPE c,             " 핫스팟
            checkbox   TYPE c,             " 체크박스
            style      TYPE lvc_style,
            col_pos    TYPE i,
          END OF ty_field_conf.


  DATA : lt_field_conf TYPE TABLE OF ty_field_conf,
         ls_conf       TYPE ty_field_conf,
         ls_fcat       TYPE lvc_s_fcat.

  lt_field_conf = VALUE #(
  " === gt_fcat: 입고 대기 구매오더 리스트 ===
  ( grid_id = '01' fieldname = 'LIGHT' coltext = TEXT-t01  outputlen = 20 fix_column = 'X')
  ( grid_id = '02' fieldname = 'POMNR' no_out = 'X' )
  ( grid_id = '02' fieldname = 'VENID' no_out = 'X' )
  ( grid_id = '02' fieldname = 'DEL' no_out = 'X' )
  ( grid_id = '02' fieldname = 'AMOUNT' coltext = 'PO수량' )
  ( grid_id = '02' fieldname = 'GRQTY'  coltext = '입고수량' )
  ( grid_id = '02' fieldname = 'REQTY'  coltext = '주문가능수량' )
  ( grid_id = '02' fieldname = 'ORQTY'  coltext = '주문수량' edit = 'X' )
  ( grid_id = '02' fieldname = 'STOID'  coltext = '창고' edit = 'X' )

  " === gt_fcat 03
  ( grid_id = '03' fieldname = 'POMNR' no_out = 'X' )
  ( grid_id = '03' fieldname = 'VENID' no_out = 'X' )
  ( grid_id = '03' fieldname = 'DEL' no_out = 'X' )
  ( grid_id = '03' fieldname = 'AMOUNT' coltext = 'PO수량' )
  ( grid_id = '03' fieldname = 'GRQTY'  coltext = '입고수량' )
  ( grid_id = '03' fieldname = 'REQTY'  coltext = '주문가능수량' )
  ( grid_id = '03' fieldname = 'ORQTY'  coltext = '주문수량' )
  ( grid_id = '03' fieldname = 'STOID'  coltext = '창고' )

  ( grid_id = '05' fieldname = 'RSTAT' no_out = 'X' )
  ( grid_id = '05' fieldname = 'VENID' no_out = 'X' )
  ( grid_id = '05' fieldname = 'RGTOR' no_out = 'X' )
  ( grid_id = '05' fieldname = 'JENUM' no_out = 'X' )
  ( grid_id = '05' fieldname = 'FYEAR' no_out = 'X' )





  ( grid_id = '05' fieldname = 'RSTAT_T' col_pos = 1 )
  ( grid_id = '05' fieldname = 'GRDAT' col_pos = 2 )
  ( grid_id = '05' fieldname = 'VNAME' col_pos = 3 )
  ( grid_id = '05' fieldname = 'ENAME' col_pos = 4 )
  ( grid_id = '05' fieldname = 'STEXT' col_pos = 5 )
  ( grid_id = '05' fieldname = 'RGDAT' col_pos = 6 )
  ( grid_id = '05' fieldname = 'LTEXT' coltext = '문서 수정' just = 'C')
  ( grid_id = '05' fieldname = 'GRNUM' hotspot = 'X' )
  " === gt_fcat6: 입고 아이템 리스트 ===
  ( grid_id = '06' fieldname = 'GRSEQ'  coltext = '아이템번호'   col_pos = 1 )
  ( grid_id = '06' fieldname = 'PONUM'  col_pos = 2 )
  ( grid_id = '06' fieldname = 'ITNUM'  col_pos = 3 )
  ( grid_id = '06' fieldname = 'MATNM'  coltext = '자재명'       col_pos = 4 )
  ( grid_id = '06' fieldname = 'AMOUNT' coltext = '입고수량'     col_pos = 5 )
  ( grid_id = '06' fieldname = 'MEINS'  coltext = '단위'         col_pos = 6 )
  ( grid_id = '06' fieldname = 'TOPRC'  coltext = '총가격'         col_pos = 7 )
  ( grid_id = '06' fieldname = 'CURKY'  coltext = '단위'         col_pos = 8 )
  ( grid_id = '06' fieldname = 'STOID'  coltext = '창고코드'     col_pos = 9  )
  ( grid_id = '06' fieldname = 'STONM'  coltext = '창고명'       col_pos = 10 )
  ( grid_id = '06' fieldname = 'VNAME'  coltext = '벤더사'       col_pos = 11 )
  ( grid_id = '06' fieldname = 'DEL'    coltext = '삭제여부'     col_pos = 12 )
  ( grid_id = '06' fieldname = 'GRNUM'    coltext = '입고문서번호'     col_pos = 13 )
  ( grid_id = '06' fieldname = 'VENID'  no_out = 'X' )
  ( grid_id = '06' fieldname = 'POMNR'  no_out = 'X' )


    " === gt_fcat7: 입고 확정이지만 수정가능한 리스트 ===
  ( grid_id = '07' fieldname = 'POMNR' no_out = 'X'  )
  ( grid_id = '07' fieldname = 'PONUM' hotspot = 'X'  )
  ( grid_id = '07' fieldname = 'VENID' no_out = 'X'  )
  ( grid_id = '07' fieldname = 'DEL'   coltext = '삭제여부'  )
  ( grid_id = '07' fieldname = 'MATNM' )

  ( grid_id = '07' fieldname = 'AMOUNT' coltext = '입고수량'   )
  ( grid_id = '07' fieldname = 'GRQTY'  no_out  = 'X'     )
  ( grid_id = '07' fieldname = 'REQTY'  no_out  = 'X'    )
  ( grid_id = '07' fieldname = 'STOID'  coltext = '창고' )
  ( grid_id = '07' fieldname = 'ORQTY'  no_out  = 'X' )
  ( grid_id = '07' fieldname = 'VNAME'  )

       " === gt_fcat8: 입고 확정이지만 수정가능한 리스트 ===
  ( grid_id = '08' fieldname = 'GRSEQ' no_out = 'X'  )
  ( grid_id = '08' fieldname = 'POMNR' no_out = 'X'  )
  ( grid_id = '08' fieldname = 'VENID' no_out = 'X'  )
  ( grid_id = '08' fieldname = 'DEL'   no_out = 'X'  )
  ( grid_id = '08' fieldname = 'MATNM' )

  ( grid_id = '08' fieldname = 'AMOUNT' coltext = 'PO수량'   )
  ( grid_id = '08' fieldname = 'GRQTY'  coltext = '입고수량'     )
  ( grid_id = '08' fieldname = 'REQTY'  no_out  = 'X'    )
  ( grid_id = '08' fieldname = 'ORQTY'  no_out = 'X' )
  ( grid_id = '08' fieldname = 'STOID'  no_out = 'X'  )
  ( grid_id = '08' fieldname = 'STONM'  no_out = 'X'  )
  ( grid_id = '08' fieldname = 'VNAME'  )

).
*  IF .
*
*  ENDIF.
*  LOOP AT gt_item ASSIGNING FIELD-SYMBOL(<fs_line>).
**    IF <fs_line>-reqty <= 0.,
*    IF <fs_line>-reqty <= 0.
*      LOOP AT gt_fcat2 INTO gs_fcat2.
*        gs_fcat2-edit = ''.
*        MODIFY gt_fcat2 FROM gs_fcat2.
*      ENDLOOP.
*    ENDIF.
*
**      APPEND ls_ctab TO <fs_line>-style.
**    ENDIF.
*  ENDLOOP.


  CLEAR : gt_fcat2,
          gt_fcat3,
          gt_fcat5,
          gt_fcat6,
          gt_fcat7,
          gt_fcat8.

*

  LOOP AT lt_field_conf INTO ls_conf.

    CLEAR ls_fcat.
    ls_fcat-fieldname = ls_conf-fieldname.
    ls_fcat-coltext   = ls_conf-coltext.
    ls_fcat-no_out    = ls_conf-no_out.
    ls_fcat-edit      = ls_conf-edit.
    ls_fcat-hotspot   = ls_conf-hotspot.
    ls_fcat-style     = ls_conf-style.
    ls_fcat-just      = ls_conf-just.
    IF ls_conf-col_pos > 0.
      ls_fcat-col_pos = ls_conf-col_pos.

    ENDIF.



    CASE ls_conf-grid_id.
      WHEN '01'. APPEND ls_fcat TO ct_fcat.
      WHEN '02'. APPEND ls_fcat TO gt_fcat2.
      WHEN '03'. APPEND ls_fcat TO gt_fcat3.
      WHEN '05'. APPEND ls_fcat TO gt_fcat5.
      WHEN '06'. APPEND ls_fcat TO gt_fcat6.
      WHEN '07'. APPEND ls_fcat TO gt_fcat7.
      WHEN '08'. APPEND ls_fcat TO gt_fcat8.
    ENDCASE.

  ENDLOOP.


  " ICON 필드 추가
*  CLEAR ls_fcat.
*  ls_fcat-fieldname = 'ICON'.
*  ls_fcat-coltext   = '아이콘'.
*  ls_fcat-icon      = 'X'.
*  ls_fcat-just      = 'C'.
*  ls_fcat-outputlen = 4.
*  ls_fcat-col_pos   = 2.
*  INSERT ls_fcat INTO ct_fcat INDEX 2.
*
*  " IT_COL 필드 추가 (색상용, 숨김)
*  CLEAR ls_fcat.
*  ls_fcat-fieldname = 'IT_COL'.
*  ls_fcat-tech      = 'X'.
*  ls_fcat-no_out    = 'X'.
*  APPEND ls_fcat TO ct_fcat.
*
*  IF gt_fcat5 IS INITIAL.
*
*
*    PERFORM set_fs_field : USING 'FIELDNAME' 'RSTAT' '' CHANGING gs_fcat5 gt_fcat5,
*                             USING 'NO_OUT' 'X' 'X' CHANGING gs_fcat5  gt_fcat5.
*    PERFORM set_fs_field : USING 'FIELDNAME' 'VENID' '' CHANGING gs_fcat5 gt_fcat5,
*                           USING 'NO_OUT' 'X' 'X' CHANGING gs_fcat5  gt_fcat5.
*    PERFORM set_fs_field : USING 'FIELDNAME' 'RGTOR' '' CHANGING gs_fcat5 gt_fcat5,
*                         USING 'NO_OUT' 'X' 'X' CHANGING gs_fcat5  gt_fcat5.
*
*    PERFORM set_fs_field : USING 'FIELDNAME' 'JENUM' '' CHANGING gs_fcat5 gt_fcat5,
*                         USING 'NO_OUT' 'X' 'X' CHANGING gs_fcat5  gt_fcat5.
*    PERFORM set_fs_field : USING 'FIELDNAME' 'FYEAR' '' CHANGING gs_fcat5 gt_fcat5,
*                         USING 'NO_OUT' 'X' 'X' CHANGING gs_fcat5  gt_fcat5.
*
*    PERFORM set_fs_field : USING 'FIELDNAME' 'GRNUM' '' CHANGING gs_fcat5 gt_fcat5,
*                           USING 'HOTSPOT' 'X' 'X' CHANGING gs_fcat5  gt_fcat5.
*
*    PERFORM set_fs_field : USING 'FIELDNAME' 'LTEXT' '' CHANGING gs_fcat5 gt_fcat5,
*                        USING 'JUST' 'C' '' CHANGING gs_fcat5  gt_fcat5,
*                        USING 'STYLE' 'CL_GUI_ALV_GRID=>MC_STYLE_BUTTON' '' CHANGING gs_fcat5 gt_fcat5,
*                      USING 'REPTEXT' '문서 수정' 'X' CHANGING gs_fcat5  gt_fcat5.
*
*  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_PO_SUM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_LT_PO_SUM  text
*----------------------------------------------------------------------*
FORM get_po_sum  CHANGING ct_po_sum LIKE gt_itamt.

  DATA: lt_po_raw TYPE STANDARD TABLE OF ztsspoi,
        ls_po_raw LIKE LINE OF lt_po_raw,
        ls_po_sum LIKE gs_itamt.

  SELECT ponum itnum amount
    INTO CORRESPONDING FIELDS OF TABLE lt_po_raw
    FROM ztsspoi.

  IF sy-subrc <> 0. RETURN. ENDIF.

  LOOP AT lt_po_raw INTO ls_po_raw.
    ls_po_sum-ponum  = ls_po_raw-ponum.
    ls_po_sum-itnum  = ls_po_raw-itnum.
    ls_po_sum-amount = ls_po_raw-amount.
    COLLECT ls_po_sum INTO ct_po_sum.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_GRDATAS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM insert_grdatas .

  DATA : lv_total_price TYPE ztsspoi-poprc.

  CLEAR gv_subrc.

  " 입고 헤더 -> item -> 전표 -> 창고 순 insert
  PERFORM insert_gr_header CHANGING gv_subrc.
  IF gv_subrc <> 0.
    ROLLBACK WORK.
    MESSAGE s999(zmcss) WITH 'Insert 실패 : HEADER 참고' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.


  PERFORM insert_gr_item CHANGING lv_total_price gv_subrc.
  IF gv_subrc <> 0.
    ROLLBACK WORK.
    MESSAGE s999(zmcss) WITH 'Insert 실패 : Item참고' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  " Create FI journal entry
  PERFORM insert_fi_journal USING lv_total_price CHANGING gv_subrc.
  IF gv_subrc <> 0.
    ROLLBACK WORK.
    MESSAGE s999(zmcss) WITH 'FI 전표 생성 실패!' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  " Create Warehouse entries
  PERFORM insert_warehouse_entries CHANGING gv_subrc.
  IF gv_subrc <> 0.
    ROLLBACK WORK.
    MESSAGE s999(zmcss) WITH '창고 입출고 기록 실패!' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

  COMMIT WORK.
  MESSAGE s999(zmcss) WITH '입고가 완료되었습니다!'.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_GR_HEADER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GV_SUBRC  text
*----------------------------------------------------------------------*
FORM insert_gr_header CHANGING cv_subrc TYPE sy-subrc.

  DATA : ls_grdata LIKE ztssgrh.

  PERFORM get_number_range USING 'ZNRSSMM02' '01' 'G' CHANGING gv_gr_num.
  PERFORM get_number_range USING 'ZNRSSFI01' '01' 'J' CHANGING gv_fi_num.

  ls_grdata-grnum = gv_gr_num.
  ls_grdata-jenum = gv_fi_num.
  ls_grdata-rstat = 'A'.
  ls_grdata-fyear = sy-datum+0(4).
  ls_grdata-grdat = zsssmm0214-grdat.
  ls_grdata-stext = gv_text.
  ls_grdata-rgdat = sy-datum.
  ls_grdata-rgtor = 'E0000003'.

  INSERT ztssgrh FROM ls_grdata.
  cv_subrc = sy-subrc.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_FI_JOURNAL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LV_TOTAL_PRICE  text
*      <--P_GV_SUBRC  text
*----------------------------------------------------------------------*
FORM insert_fi_journal  USING  VALUE(pv_val) TYPE ztsspoi-poprc
                        CHANGING cv_subrc TYPE sy-subrc.

  DATA : ls_fidata TYPE ztssjeh.
  ls_fidata-jenum = gv_fi_num.
  ls_fidata-fyear = sy-datum+0(4).
  ls_fidata-jtype = 'WE'.
  ls_fidata-stext = |{ gv_gr_num }의 자동전표|.
  ls_fidata-curky = 'KRW'.
  ls_fidata-rgdat = sy-datum.

  INSERT ztssjeh FROM ls_fidata.
  IF sy-subrc <> 0. cv_subrc = sy-subrc. RETURN. ENDIF.


  PERFORM insert_fi_journal_item USING '001' pv_val '' '310000' CHANGING cv_subrc.
  IF sy-subrc <> 0. cv_subrc = sy-subrc. RETURN. ENDIF.
  PERFORM insert_fi_journal_item USING '002' '' pv_val '910000' CHANGING cv_subrc.
  IF sy-subrc <> 0. cv_subrc = sy-subrc. RETURN. ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_WAREHOUSE_ENTRIES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GV_SUBRC  text
*----------------------------------------------------------------------*
FORM insert_warehouse_entries CHANGING cv_subrc TYPE sy-subrc.

  DATA: ls_ware TYPE ztssware.

  FIELD-SYMBOLS: <fs_confirm> LIKE LINE OF gt_confirm.

  LOOP AT gt_confirm ASSIGNING <fs_confirm>.

    PERFORM get_number_range USING 'ZNRSSMD06' '01' 'W' CHANGING gv_wh_num.

    ls_ware-warid  = gv_wh_num.
    ls_ware-stoid  = <fs_confirm>-stoid.
    ls_ware-matnr  = <fs_confirm>-pomnr.
    ls_ware-amount = <fs_confirm>-orqty.
    ls_ware-wtype  = 'I'.
    ls_ware-wdate  = sy-datum.
    ls_ware-grnum  = gv_gr_num.
    ls_ware-rgdat  = sy-datum.
    ls_ware-rgtor  = 'E0000012'.
    ls_ware-meins  = <fs_confirm>-meins.

    INSERT ztssware FROM ls_ware.
    IF sy-subrc <> 0. cv_subrc = sy-subrc. EXIT. ENDIF.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_FI_JOURNAL_ITEM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_2359   text
*      -->P_PV_VAL  text
*      -->P_2361   text
*      -->P_2362   text
*      <--P_CV_SUBRC  text
*----------------------------------------------------------------------*
FORM insert_fi_journal_item  USING    VALUE(p_seq) TYPE ztssjei-jeseq
                                      VALUE(p_debit) TYPE ztssjei-debit
                                      VALUE(p_credit) TYPE ztssjei-credit
                                      VALUE(p_acc) TYPE ztssjei-glacc
                             CHANGING cv_subrc TYPE sy-subrc.


  DATA: ls_fiitem TYPE ztssjei.

  ls_fiitem-jenum  = gv_fi_num.
  ls_fiitem-fyear  = sy-datum+0(4).
  ls_fiitem-jeseq  = p_seq.
  ls_fiitem-debit  = p_debit.
  ls_fiitem-credit = p_credit.
  ls_fiitem-curky  = 'KRW'.
  ls_fiitem-glacc  = p_acc.

  INSERT ztssjei FROM ls_fiitem.
  cv_subrc = sy-subrc.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_GR_ITEM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_LV_TOTAL_PRICE  text
*      <--P_GV_SUBRC  text
*----------------------------------------------------------------------*
FORM insert_gr_item CHANGING  cv_total_price TYPE ztsspoi-poprc
                              cv_subrc TYPE sy-subrc.


  " Insert Gr items and Calculate total price
  PERFORM insert_gr_items CHANGING cv_total_price cv_subrc.

  IF cv_subrc <> 0.
    ROLLBACK WORK.
    MESSAGE s999(zmcss) WITH 'GR item 삽입 실패!' DISPLAY LIKE 'E'.
    RETURN.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_GR_ITEMS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_CV_TOTAL_PRICE  text
*      <--P_CV_SUBRC  text
*----------------------------------------------------------------------*
FORM insert_gr_items  CHANGING cv_total_price TYPE ztsspoi-poprc
                               cv_subrc TYPE sy-subrc.

  DATA: ls_gritem     TYPE ztssgri,
        lv_item_price TYPE ztssprcat-vnprc.

  CLEAR : cv_total_price.

  LOOP AT gt_confirm ASSIGNING FIELD-SYMBOL(<fs_confirm>).

    ls_gritem-grnum = gv_gr_num.
    ls_gritem-grseq  = <fs_confirm>-grseq.
    ls_gritem-ponum  = <fs_confirm>-ponum.
    ls_gritem-itnum  = <fs_confirm>-itnum.
    ls_gritem-amount = <fs_confirm>-orqty.
    ls_gritem-meins  = <fs_confirm>-meins.
    ls_gritem-stoid  = <fs_confirm>-stoid.

    PERFORM get_venmat USING <fs_confirm>-venid <fs_confirm>-pomnr CHANGING lv_item_price.
    cv_total_price = cv_total_price + ( lv_item_price * <fs_confirm>-orqty ).

    INSERT ztssgri FROM ls_gritem.
    IF sy-subrc <> 0. cv_subrc = sy-subrc. EXIT. ENDIF.

  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_FS_FIELD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_2120   text
*      -->P_2121   text
*      -->P_2122   text
*      <--P_GS_FCAT5  text
*      <--P_GT_FCAT5  text
*----------------------------------------------------------------------*
FORM set_fs_field USING     VALUE(p_input)
                            VALUE(p_val)
                            VALUE(p_flag)
                   CHANGING cs_fcat TYPE lvc_s_fcat
                            ct_fcat TYPE lvc_t_fcat.
  DATA : lv_field(40).
  FIELD-SYMBOLS <fs>.

  lv_field = 'CS_FCAT-' && p_input.
  ASSIGN (lv_field) TO <fs>.

  IF <fs> IS ASSIGNED.
    IF p_val = 'N'.
      READ TABLE ct_fcat INTO cs_fcat WITH KEY fieldname = p_input.
      <fs> = sy-tabix + 1.
    ELSE.
      <fs> = p_val.
    ENDIF.
    UNASSIGN <fs>.
  ENDIF.

  IF p_flag = 'X'.
    APPEND cs_fcat TO ct_fcat.
    CLEAR cs_fcat.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  EDIT_GRDOC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM edit_grdoc .
  DATA : lv_answer.

  PERFORM popup_to_confirm
  USING    '입고최종수정'                " 제목
           '정말 입고를 수정하시겠습니까?'       " 질문
           'Yes'                         " 버튼1 텍스트
           'ICON_CHECKED'                " 버튼1 아이콘
           'No'                          " 버튼2 텍스트
           'ICON_INCOMPLETE'             " 버튼2 아이콘
           '누르면 입고수정이 완료됩니다'     " 버튼1 퀵인포
           '누르면 입고수정이 취소됩니다'     " 버튼2 퀵인포
  CHANGING lv_answer.



  CASE lv_answer.
    WHEN '1'.
*      PERFORM update_editgr_header.
      PERFORM update_gr_docs CHANGING gv_subrc.
      LEAVE TO SCREEN 0.
    WHEN '2'.
    WHEN '3'.
  ENDCASE.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  UPDATE_GR_DOCS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GV_SUBRC  text
*----------------------------------------------------------------------*
FORM update_gr_docs CHANGING cv_subrc TYPE sy-subrc .


  DATA: ls_grh   TYPE ztssgrh,
        ls_money TYPE ty_money,
        lv_valid TYPE abap_bool.

  " item valid 한지 체크 -> 모두 삭제됐다면, 입고되지 않음
  PERFORM validate_edit_items CHANGING lv_valid.
  IF lv_valid = abap_false.
    RETURN.
  ENDIF.

  " 정보 찾아서 입고 헤더->아이템-> 전표 -> 창고 순으로 update
  PERFORM get_gr_header USING zsssmm0211-grnum
                        CHANGING ls_grh.
  PERFORM get_journal_amounts USING ls_grh-jenum
                                    ls_grh-fyear
                              CHANGING ls_money.

  PERFORM create_reversal_journal USING ls_grh ls_money cv_subrc.


  PERFORM update_gr_header CHANGING cv_subrc.
  IF cv_subrc <> 0. ROLLBACK WORK. RETURN. ENDIF.

  PERFORM update_gr_items USING ls_grh-grnum CHANGING cv_subrc.
  PERFORM process_warehouse_movements CHANGING cv_subrc.

  COMMIT WORK.
  MESSAGE s999(zmcss) WITH '입고수정이 완료되었습니다!'.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  VALIDATE_EDIT_ITEMS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_LV_VALID  text
*----------------------------------------------------------------------*
FORM validate_edit_items  CHANGING cv_valid TYPE abap_bool.

  DATA : ls_edit_item LIKE LINE OF gt_edit_item.

  cv_valid = abap_false.

  LOOP AT gt_edit_item INTO ls_edit_item WHERE del IS INITIAL.
    cv_valid = abap_true.
    EXIT.
  ENDLOOP.

  IF cv_valid = abap_false.
    MESSAGE s999(zmcss) WITH '입고 수정 시 아이템은 1개 이상 필수입니다!'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_GR_HEADER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ZSSSMM0211_GRNUM  text
*      <--P_LS_GRH  text
*----------------------------------------------------------------------*
FORM get_gr_header  USING VALUE(pv_grnum) TYPE ztssgrh-grnum
                   CHANGING cs_grh TYPE ztssgrh.

  SELECT SINGLE grnum rstat grdat jenum fyear stext rgdat rgtor
    INTO CORRESPONDING FIELDS OF cs_grh
    FROM ztssgrh
    WHERE grnum = pv_grnum.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_JOURNAL_AMOUNTS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_GRH_JENUM  text
*      -->P_LS_GRH_FYEAR  text
*      <--P_LS_MONEY  text
*----------------------------------------------------------------------*
FORM get_journal_amounts  USING VALUE(pv_jenum) TYPE ztssjei-jenum
                               VALUE(pv_fyear) TYPE ztssjei-fyear
                         CHANGING cs_money TYPE ty_money.

  SELECT SINGLE debit
    INTO cs_money-debit
    FROM ztssjei
    WHERE jenum = pv_jenum
      AND fyear = pv_fyear
      AND jeseq = '001'.

  SELECT SINGLE credit
    INTO cs_money-credit
    FROM ztssjei
    WHERE jenum = pv_jenum
      AND fyear = pv_fyear
      AND jeseq = '002'.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CREATE_REVERSAL_JOURNAL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_GRH  text
*      -->P_LS_MONEY  text
*      -->P_CV_SUBRC  text
*----------------------------------------------------------------------*
FORM create_reversal_journal  USING VALUE(ps_grh) TYPE ztssgrh
                                    VALUE(ps_money) TYPE ty_money
                              CHANGING cv_subrc TYPE sy-subrc.
  " 추후 서브루틴 예정
  DATA: ls_jeh   TYPE ztssjeh,
        ls_jei   TYPE ztssjei,
        lv_price TYPE ztssjei-debit,
        lv_stext TYPE ztssjeh-stext.

  cv_subrc = 0.


  PERFORM get_number_range USING 'ZNRSSFI01' '01' 'J' CHANGING gv_fi_num.


  " 전표 헤더 생성
  ls_jeh-jenum = gv_fi_num.
  ls_jeh-fyear = sy-datum+0(4).
  ls_jeh-jtype = 'WE'.
  ls_jeh-stext = |{ ps_grh-grnum }의 자동전표의 역분개|.
  ls_jeh-curky = 'KRW'.
  ls_jeh-rgdat = sy-datum.
  INSERT ztssjeh FROM ls_jeh.
  cv_subrc = sy-subrc.
  IF cv_subrc <> 0. ROLLBACK WORK. RETURN. ENDIF.


  " 전표 아이템 생성 (차변)
  lv_price = ps_money-debit * -1.

  PERFORM insert_journal_item USING gv_fi_num
                                    sy-datum+0(4)
                                    '001'
                                    lv_price
                                    space
                                    '310000'
                                    cv_subrc.
  CLEAR lv_price.

  " 대변 금액
  lv_price = ps_money-credit * -1.
  IF cv_subrc <> 0. ROLLBACK WORK. RETURN. ENDIF.



  " 전표 아이템 생성 (대변)
  PERFORM insert_journal_item USING gv_fi_num
                                    sy-datum+0(4)
                                    '002'
                                    space
                                    lv_price
                                    '910000'
                                    cv_subrc.
  IF cv_subrc <> 0. ROLLBACK WORK. RETURN. ENDIF.

  CONCATENATE ps_grh-grnum '의 자동전표의 역분개' INTO lv_stext.


  " 원본 전표 역분개 표시
  UPDATE ztssjeh
    SET rev   = 'X'
        rrson = lv_stext
        rjnum = gv_fi_num
    WHERE jenum = ps_grh-jenum
      AND fyear = ps_grh-fyear.
  cv_subrc = sy-subrc.
  IF cv_subrc <> 0. ROLLBACK WORK. RETURN. ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_JOURNAL_ITEM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GV_FI_NUM  text
*      -->P_SY_DATUM+0(4)  text
*      -->P_3708   text
*      -->P_LV_PRICE  text
*      -->P_SPACE  text
*      -->P_3711   text
*      -->P_CV_SUBRC  text
*----------------------------------------------------------------------*
FORM insert_journal_item  USING VALUE(pv_jenum) TYPE ztssjei-jenum
                               VALUE(pv_fyear) TYPE ztssjei-fyear
                               VALUE(pv_jeseq) TYPE ztssjei-jeseq
                               VALUE(pv_debit) TYPE ztssjei-debit
                               VALUE(pv_credit) TYPE ztssjei-credit
                               VALUE(pv_glacc) TYPE ztssjei-glacc
                          CHANGING cv_subrc TYPE sy-subrc.

  DATA: ls_jei TYPE ztssjei.

  ls_jei-jenum  = pv_jenum.
  ls_jei-fyear  = pv_fyear.
  ls_jei-jeseq  = pv_jeseq.
  ls_jei-debit  = pv_debit.
  ls_jei-credit = pv_credit.
  ls_jei-curky  = 'KRW'.
  ls_jei-glacc  = pv_glacc.

  INSERT ztssjei FROM ls_jei.
  cv_subrc = sy-subrc.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  UPDATE_GR_HEADER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_CV_SUBRC  text
*----------------------------------------------------------------------*
FORM update_gr_header CHANGING cv_subrc TYPE sy-subrc.

  UPDATE ztssgrh
   SET grdat = zsssmm0211-grdat
       stext = zsssmm0211-stext
       rgdat = zsssmm0211-rgdat
       rgtor = zsssmm0211-rgtor
   WHERE grnum = zsssmm0211-grnum.

  cv_subrc = sy-subrc.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  UPDATE_GR_ITEMS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_GRH_GRNUM  text
*      <--P_CV_SUBRC  text
*----------------------------------------------------------------------*
FORM update_gr_items USING VALUE(pv_grnum) TYPE ztssgrh-grnum
                     CHANGING cv_subrc TYPE sy-subrc.

  DATA : lv_canc_qty TYPE ztssgri-amount.

  LOOP AT gt_edit_item INTO gs_edit_item.

    IF gs_edit_item-del = 'X'.
      lv_canc_qty = gs_edit_item-amount * -1.
      UPDATE ztssgri
      SET stoid  = gs_edit_item-stoid
          amount = 0
          del    = gs_edit_item-del
      WHERE grnum = pv_grnum
        AND grseq = gs_edit_item-grseq.
      cv_subrc = sy-subrc.
      IF cv_subrc <> 0.
        ROLLBACK WORK.
        RETURN.
      ENDIF.
    ELSE.
      UPDATE ztssgri
        SET stoid  = gs_edit_item-stoid
            amount = gs_edit_item-amount
            del    = gs_edit_item-del
        WHERE grnum = pv_grnum
          AND grseq = gs_edit_item-grseq.
      cv_subrc = sy-subrc.
      IF cv_subrc <> 0.
        ROLLBACK WORK.
        RETURN.
      ENDIF.
    ENDIF.
  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  PROCESS_WAREHOUSE_MOVEMENTS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_CV_SUBRC  text
*----------------------------------------------------------------------*
FORM process_warehouse_movements CHANGING cv_subrc TYPE sy-subrc.

  DATA: ls_ware TYPE ztssware,
        lv_diff TYPE i.

  LOOP AT gt_edit_item INTO gs_edit_item.

    " 기존 수량과 비교
    READ TABLE gt_temp INTO gs_temp
      WITH KEY ponum = gs_edit_item-ponum
               itnum = gs_edit_item-itnum.

    CHECK sy-subrc = 0.

    lv_diff = gs_temp-amount - gs_edit_item-amount.
    CHECK lv_diff <> 0.

    " 창고 입출고 레코드
    PERFORM get_number_range USING 'ZNRSSMD06' '01' 'W' CHANGING gv_wh_num.
    PERFORM create_warehouse_record USING gs_edit_item
                                          lv_diff
                                          gv_wh_num
                                    CHANGING cv_subrc.
    IF cv_subrc <> 0.
      ROLLBACK WORK.
      RETURN.
    ENDIF.

  ENDLOOP.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CREATE_WAREHOUSE_RECORD
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GS_EDIT_ITEM  text
*      -->P_LV_DIFF  text
*      -->P_GV_WH_NUM  text
*      <--P_CV_SUBRC  text
*----------------------------------------------------------------------*
FORM create_warehouse_record  USING VALUE(ps_item) LIKE gs_edit_item
                                   VALUE(pv_diff) TYPE i
                                   VALUE(pv_warid) TYPE ztssware-warid
                              CHANGING cv_subrc TYPE sy-subrc.

  DATA: ls_ware TYPE ztssware.

  ls_ware-warid  = pv_warid.
  ls_ware-stoid  = ps_item-stoid.
  ls_ware-matnr  = ps_item-pomnr.
  ls_ware-amount = ps_item-amount.

  " if - elseif - else 문과 비슷함 (삼항연산자)
  ls_ware-wtype  = COND #( WHEN pv_diff > 0 THEN 'O'  " 출고
                           WHEN pv_diff < 0 THEN 'I'  " 입고
                           ELSE space ).
  ls_ware-wdate  = sy-datum.
  ls_ware-grnum  = gv_gr_num.
  ls_ware-rgdat  = sy-datum.
  ls_ware-rgtor  = 'E0000012'.
  ls_ware-meins  = ps_item-meins.

  CHECK ls_ware-wtype IS NOT INITIAL.
  INSERT ztssware FROM ls_ware.

  cv_subrc = sy-subrc.
ENDFORM.

----------------------------------------------------------------------------------
Extracted by Mass Download version 1.5.5 - E.G.Mellodew. 1998-2025. Sap Release 750

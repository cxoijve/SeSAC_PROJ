*&---------------------------------------------------------------------*
*&      Form  SET_LAYO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_LAYO .
  CLEAR GS_LAYO.

  GS_LAYO-CWIDTH_OPT = 'X'.
  GS_LAYO-ZEBRA = 'X'.
  GS_LAYO-SEL_MODE = 'A'.

  CLEAR GS_LAYO2.

  GS_LAYO2-CWIDTH_OPT = 'X'.
  GS_LAYO2-ZEBRA = 'X'.
  GS_LAYO2-SEL_MODE = 'A'.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_SORT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_SORT .

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_FCAT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_FCAT .

  CLEAR: GT_FCAT.

  PERFORM FCAT USING:
        'JENUM' '3' '전표번호',
        'FYEAR' '4' '회계연도',
        'IVNUM' '5' '송장 문서 번호',
        'IVDAT' '6' '송장 검증일',
        'TOPRC' '7' '총 금액',
        'STEXT' '8' '비고',
        'CURKY' '9' '통화 키',
        'RGDAT' '10' '등록일',
        'RGTOR' '11' '등록자',
        'APNUM' '1' '지급 전표번호',
        'APFYR' '2' '지급 회계연도'.

  CLEAR GS_FCAT.

  LOOP AT GT_FCAT INTO GS_FCAT.
    IF GS_FCAT-FIELDNAME = 'TOPRC'.
      GS_FCAT-CFIELDNAME = 'CURKY'.
    ENDIF.

    MODIFY GT_FCAT FROM GS_FCAT.
  ENDLOOP.

  CLEAR: GT_FCAT2.

  PERFORM FCAT2 USING:
        'JENUM' '3' '전표번호',
        'FYEAR' '4' '회계연도',
        'BINUM' '5' '청구 문서 번호',
        'BIDAT' '6' '청구일',
        'TOPRC' '7' '총 금액',
        'STEXT' '8' '비고',
        'CURKY' '9' '통화 키',
        'RGDAT' '10' '등록일',
        'RGTOR' '11' '등록자',
        'ARNUM' '1' '수금 전표번호',
        'ARFYR' '2' '수금 회계연도'.

  CLEAR GS_FCAT2.

  LOOP AT GT_FCAT2 INTO GS_FCAT2.
    IF GS_FCAT2-FIELDNAME = 'TOPRC'.
      GS_FCAT2-CFIELDNAME = 'CURKY'.
    ENDIF.

    MODIFY GT_FCAT2 FROM GS_FCAT2.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  FCAT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_0025   text
*      -->P_0026   text
*      -->P_0027   text
*----------------------------------------------------------------------*
FORM FCAT  USING    VALUE(P_FIELDNAME)
                    VALUE(P_COLPOS)
                    VALUE(P_COLTEXT).

  DATA LS_FCAT LIKE LINE OF GT_FCAT.

  LS_FCAT-FIELDNAME = P_FIELDNAME.
  LS_FCAT-COL_POS = P_COLPOS.
  LS_FCAT-COLTEXT = P_COLTEXT.
  APPEND LS_FCAT TO GT_FCAT.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_INIT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_INIT .
  ZSBFI02-COND3 = 'X'.

  PERFORM GET_MIVH_DATA.

  PERFORM GET_SIVH_DATA.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  FCAT2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_0106   text
*      -->P_0107   text
*      -->P_0108   text
*----------------------------------------------------------------------*
FORM FCAT2  USING    VALUE(P_FIELDNAME)
                    VALUE(P_COLPOS)
                    VALUE(P_COLTEXT).

  DATA LS_FCAT2 LIKE LINE OF GT_FCAT2.

  LS_FCAT2-FIELDNAME = P_FIELDNAME.
  LS_FCAT2-COL_POS = P_COLPOS.
  LS_FCAT2-COLTEXT = P_COLTEXT.
  APPEND LS_FCAT2 TO GT_FCAT2.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SEL_ROWS_0100
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SEL_ROWS_0400   CHANGING PV_SUBRC.

  " 행 선택 처리
  DATA: LV_LINE TYPE I.

  PERFORM GET_SELECTED_ROWS CHANGING GT_ROWS.

  DESCRIBE TABLE GT_ROWS LINES LV_LINE.
  CASE LV_LINE.
    WHEN '0'.
      MESSAGE S999(ZMCSS) WITH '수정할 데이터를 선택해주세요.' DISPLAY LIKE 'E'.
      PV_SUBRC = 4.
      RETURN.
    WHEN '1'.

      READ TABLE GT_ROWS INDEX 1 INTO GS_ROWS.

    WHEN OTHERS.
      MESSAGE S999(ZMCSS) WITH '데이터를 한 행만 선택하세요.' DISPLAY LIKE 'E'.
      PV_SUBRC = 4.
      RETURN.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_SELECTED_ROWS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_ROWS  text
*----------------------------------------------------------------------*
FORM GET_SELECTED_ROWS CHANGING PT_ROWS TYPE LVC_T_ROW.

  CLEAR: PT_ROWS.

  CALL METHOD GO_ALV->GET_SELECTED_ROWS
    IMPORTING
      ET_INDEX_ROWS = PT_ROWS.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CREATE_ALV_0400
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM CREATE_ALV_0400 .

  " 객체가 있을 시 미생성
  IF GO_CON IS NOT INITIAL.
    RETURN.
  ENDIF.

  CREATE OBJECT GO_CON
    EXPORTING
*     PARENT                      =
      CONTAINER_NAME              = 'CON'
*     STYLE                       =
*     LIFETIME                    = lifetime_default
*     REPID                       =
*     DYNNR                       =
*     NO_AUTODEF_PROGID_DYNNR     =
    EXCEPTIONS
      CNTL_ERROR                  = 1
      CNTL_SYSTEM_ERROR           = 2
      CREATE_ERROR                = 3
      LIFETIME_ERROR              = 4
      LIFETIME_DYNPRO_DYNPRO_LINK = 5
      OTHERS                      = 6.
  IF SY-SUBRC <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*              WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CREATE OBJECT GO_ALV
    EXPORTING
*     I_SHELLSTYLE      = 0
*     I_LIFETIME        =
      I_PARENT          = GO_CON
*     I_APPL_EVENTS     = space
*     I_PARENTDBG       =
*     I_APPLOGPARENT    =
*     I_GRAPHICSPARENT  =
*     I_NAME            =
*     I_FCAT_COMPLETE   = SPACE
    EXCEPTIONS
      ERROR_CNTL_CREATE = 1
      ERROR_CNTL_INIT   = 2
      ERROR_CNTL_LINK   = 3
      ERROR_DP_CREATE   = 4
      OTHERS            = 5.
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_FCAT_0400
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_FCAT_0400 .

  CLEAR: GT_FCAT.

  PERFORM FCAT USING:
        'APNUM' '1' '지급 전표번호',
        'APFYR' '2' '지급 회계연도',
        'JENUM' '3' '전표번호',
        'FYEAR' '4' '회계연도',
        'TOPRC' '5' '총 금액',
        'CURKY' '6' '통화 키',
        'IVNUM' '7' '송장 문서번호',
        'RGDAT' '8' '등록일',
        'IVDAT' '9' '송장 검증일',
        'STEXT' '10' '비고',
        'RGTOR' '11' '등록자'.

  CLEAR GS_FCAT.

  LOOP AT GT_FCAT INTO GS_FCAT.
    IF GS_FCAT-FIELDNAME = 'TOPRC'.
      GS_FCAT-CFIELDNAME = 'CURKY'.

    ELSEIF GS_FCAT-FIELDNAME = 'JENUM'.
      GS_FCAT-HOTSPOT = 'X'.

    ELSEIF GS_FCAT-FIELDNAME = 'IVNUM'.
      GS_FCAT-HOTSPOT = 'X'.

    ELSEIF GS_FCAT-FIELDNAME = 'APNUM'.
      GS_FCAT-HOTSPOT = 'X'.

    ELSEIF GS_FCAT-FIELDNAME = 'RGTOR'.
      GS_FCAT-NO_OUT = 'X'.
    ENDIF.

    MODIFY GT_FCAT FROM GS_FCAT.
  ENDLOOP.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV_0400
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM DISPLAY_ALV_0400 .

  CALL METHOD GO_ALV->SET_TABLE_FOR_FIRST_DISPLAY
    EXPORTING
      IS_LAYOUT       = GS_LAYO
    CHANGING
      IT_OUTTAB       = GT_MHDATA
      IT_FIELDCATALOG = GT_FCAT
      IT_SORT         = GT_SORT
    .
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CREATE_ALV_0500
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM CREATE_ALV_0500 .

  " 객체가 있을 시 미생성
  IF GO_CON2 IS NOT INITIAL.
    RETURN.
  ENDIF.

  CREATE OBJECT GO_CON2
    EXPORTING
      CONTAINER_NAME              = 'CON2'
    EXCEPTIONS
      CNTL_ERROR                  = 1
      CNTL_SYSTEM_ERROR           = 2
      CREATE_ERROR                = 3
      LIFETIME_ERROR              = 4
      LIFETIME_DYNPRO_DYNPRO_LINK = 5
      OTHERS                      = 6.
  IF SY-SUBRC <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*              WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CREATE OBJECT GO_ALV2
    EXPORTING
      I_PARENT          = GO_CON2
    EXCEPTIONS
      ERROR_CNTL_CREATE = 1
      ERROR_CNTL_INIT   = 2
      ERROR_CNTL_LINK   = 3
      ERROR_DP_CREATE   = 4
      OTHERS            = 5.
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_FCAT_0500
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_FCAT_0500 .

  CLEAR: GT_FCAT2.

  PERFORM FCAT2 USING:
        'ARNUM' '1' '수금 전표번호',
        'ARFYR' '2' '수금 회계연도',
        'JENUM' '3' '전표번호',
        'FYEAR' '4' '회계연도',
        'TOPRC' '5' '총 금액',
        'CURKY' '6' '통화 키',
        'BINUM' '7' '청구 문서번호',
        'RGDAT' '8' '등록일',
        'BIDAT' '9' '청구일',
        'STEXT' '10' '비고',
        'RGTOR' '11' '등록자'.

  CLEAR GS_FCAT2.

  LOOP AT GT_FCAT2 INTO GS_FCAT2.
    IF GS_FCAT2-FIELDNAME = 'TOPRC'.
      GS_FCAT2-CFIELDNAME = 'CURKY'.

    ELSEIF GS_FCAT2-FIELDNAME = 'JENUM'.
      GS_FCAT2-HOTSPOT = 'X'.

    ELSEIF GS_FCAT2-FIELDNAME = 'BINUM'.
      GS_FCAT2-HOTSPOT = 'X'.

    ELSEIF GS_FCAT2-FIELDNAME = 'ARNUM'.
      GS_FCAT2-HOTSPOT = 'X'.

    ELSEIF GS_FCAT2-FIELDNAME = 'RGTOR'.
      GS_FCAT2-NO_OUT = 'X'.

    ENDIF.


    MODIFY GT_FCAT2 FROM GS_FCAT2.
  ENDLOOP.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV_0500
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM DISPLAY_ALV_0500 .


  CALL METHOD GO_ALV2->SET_TABLE_FOR_FIRST_DISPLAY
    EXPORTING
      IS_LAYOUT       = GS_LAYO2
    CHANGING
      IT_OUTTAB       = GT_SHDATA
      IT_FIELDCATALOG = GT_FCAT2
      IT_SORT         = GT_SORT.
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_DATA_0400
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_DATA_0400 .

  CLEAR ZSSSFI0203.

  " 송장검증 IV의 전표번호 헤더 정보 취득
  PERFORM GET_JEH_DATA.

  READ TABLE GT_HDATA INTO GS_HDATA WITH KEY JENUM = GS_MHDATA-JENUM.
  MOVE-CORRESPONDING GS_HDATA TO ZSSSFI0203.


  PERFORM GET_RGTOR_NAME USING ZSSSFI0203-RGTOR
                         CHANGING ZSSSFI0203-RGTOR_T.

  " 자동전표일 경우, 등록자명 AutoFIBot
  IF ZSSSFI0203-RGTOR IS INITIAL.
    ZSSSFI0203-RGTOR_T = 'AutoFIBot'.
  ENDIF.

  " 송장검증 IV의 라인아이템 정보 취득
  PERFORM GET_MJEI_DATA.


  " 송장검증 IV 전표 차/대 분개 표시
  PERFORM CAL_SUM_DC CHANGING ZSSSFI0204-DEBIT
                                                        ZSSSFI0204-CREDIT.

  ZSSSFI0204-CURKY = ZSSSFI0203-CURKY.


  " 반제전표 생성(기본값)
  PERFORM SET_AP_INIT.

  PERFORM CAL_SUM_DC CHANGING ZSSSFI0206-DEBIT
                                                        ZSSSFI0206-CREDIT.

  ZSSSFI0206-CURKY = ZSSSFI0205-CURKY.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_JEI_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_MJEI_DATA .

  " 라인아이템 정보 취득
  SELECT JENUM FYEAR JESEQ DEBIT CREDIT CURKY GLACC
    FROM ZTSSJEI
    INTO CORRESPONDING FIELDS OF TABLE GT_ADATA
    WHERE JENUM = GS_MHDATA-JENUM
      AND FYEAR = GS_MHDATA-FYEAR.

  " G/L 계정명 취득
  LOOP AT GT_ADATA INTO GS_ADATA.
    PERFORM GET_GL_NAME USING GS_ADATA-GLACC
                        CHANGING GS_ADATA-ACTNM.

    MODIFY GT_ADATA FROM GS_ADATA.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_GL_NAME
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GS_ADATA_GLACC  text
*      <--P_GS_ADATA_ACTNM  text
*----------------------------------------------------------------------*
FORM GET_GL_NAME  USING    P_GLACC
                  CHANGING CT_NAME.

  DATA: LT_GL TYPE TABLE OF ZTSSACNT,
        LS_GL LIKE LINE OF LT_GL.

  SELECT GLACC ACTNM
    FROM ZTSSACNT
    INTO CORRESPONDING FIELDS OF TABLE LT_GL.

  READ TABLE LT_GL INTO LS_GL WITH KEY GLACC = P_GLACC.
  CT_NAME = LS_GL-ACTNM.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CREATE_ALV_0300
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM CREATE_ALV_0300 .

  " 객체가 있을 시 미생성
  IF GO_CON3 IS NOT INITIAL.
    RETURN.
  ENDIF.

  CREATE OBJECT GO_CON3
    EXPORTING
      CONTAINER_NAME              = 'CON3'
    EXCEPTIONS
      CNTL_ERROR                  = 1
      CNTL_SYSTEM_ERROR           = 2
      CREATE_ERROR                = 3
      LIFETIME_ERROR              = 4
      LIFETIME_DYNPRO_DYNPRO_LINK = 5
      OTHERS                      = 6.
  IF SY-SUBRC <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*              WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CREATE OBJECT GO_ALV3
    EXPORTING
      I_PARENT          = GO_CON3
    EXCEPTIONS
      ERROR_CNTL_CREATE = 1
      ERROR_CNTL_INIT   = 2
      ERROR_CNTL_LINK   = 3
      ERROR_DP_CREATE   = 4
      OTHERS            = 5.
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.




  " 객체가 있을 시 미생성
  IF GO_CON4 IS NOT INITIAL.
    RETURN.
  ENDIF.

  CREATE OBJECT GO_CON4
    EXPORTING
      CONTAINER_NAME              = 'CON4'
    EXCEPTIONS
      CNTL_ERROR                  = 1
      CNTL_SYSTEM_ERROR           = 2
      CREATE_ERROR                = 3
      LIFETIME_ERROR              = 4
      LIFETIME_DYNPRO_DYNPRO_LINK = 5
      OTHERS                      = 6.
  IF SY-SUBRC <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*              WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CREATE OBJECT GO_ALV4
    EXPORTING
      I_PARENT          = GO_CON4
    EXCEPTIONS
      ERROR_CNTL_CREATE = 1
      ERROR_CNTL_INIT   = 2
      ERROR_CNTL_LINK   = 3
      ERROR_DP_CREATE   = 4
      OTHERS            = 5.
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.




ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_FCAT_0300
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_FCAT_0300 .

  CLEAR: GT_FCAT.

  PERFORM FCAT USING:
        'JENUM' '1' '전표번호',
        'FYEAR' '2' '회계연도',
        'JESEQ' '3' '전표 아이템 번호',
        'DEBIT' '4' '차변',
        'CREDIT' '5' '대변',
        'CURKY' '6' '통화 키',
        'GLACC' '7' 'G/L 계정',
        'ACTNM' '8' 'G/L 계정명'.

  CLEAR GS_FCAT.

  LOOP AT GT_FCAT INTO GS_FCAT.
    IF GS_FCAT-FIELDNAME = 'JESEQ'.
      GS_FCAT-LZERO = 'X'.
    ELSEIF GS_FCAT-FIELDNAME = 'JENUM' OR GS_FCAT-FIELDNAME = 'FYEAR' .
      GS_FCAT-NO_OUT = 'X'.
    ELSEIF GS_FCAT-FIELDNAME = 'DEBIT' OR GS_FCAT-FIELDNAME = 'CREDIT'.
      GS_FCAT-CFIELDNAME = 'CURKY'.
    ENDIF.

    MODIFY GT_FCAT FROM GS_FCAT.
  ENDLOOP.

  CLEAR: GT_FCAT2.

  PERFORM FCAT2 USING:
        'JENUM' '1' '전표번호',
        'FYEAR' '2' '회계연도',
        'JESEQ' '3' '전표 아이템 번호',
        'DEBIT' '4' '차변',
        'CREDIT' '5' '대변',
        'CURKY' '6' '통화 키',
        'GLACC' '7' 'G/L 계정',
        'ACTNM' '8' 'G/L 계정명'.

  CLEAR GS_FCAT2.

  LOOP AT GT_FCAT2 INTO GS_FCAT2.
    IF GS_FCAT2-FIELDNAME = 'JESEQ'.
      GS_FCAT2-LZERO = 'X'.
    ELSEIF GS_FCAT2-FIELDNAME = 'JENUM' OR GS_FCAT2-FIELDNAME = 'FYEAR' .
      GS_FCAT2-NO_OUT = 'X'.
    ELSEIF GS_FCAT2-FIELDNAME = 'DEBIT' OR GS_FCAT2-FIELDNAME = 'CREDIT'.
      GS_FCAT2-CFIELDNAME = 'CURKY'.
    ENDIF.

    MODIFY GT_FCAT2 FROM GS_FCAT2.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV_0300
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM DISPLAY_ALV_0300 .

  CALL METHOD GO_ALV3->SET_TABLE_FOR_FIRST_DISPLAY
    EXPORTING
      IS_LAYOUT       = GS_LAYO
    CHANGING
      IT_OUTTAB       = GT_ADATA
      IT_FIELDCATALOG = GT_FCAT
      IT_SORT         = GT_SORT.
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.



  CALL METHOD GO_ALV4->SET_TABLE_FOR_FIRST_DISPLAY
    EXPORTING
      IS_LAYOUT       = GS_LAYO
    CHANGING
      IT_OUTTAB       = GT_CIDATA
      IT_FIELDCATALOG = GT_FCAT2
      IT_SORT         = GT_SORT.
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_RGTOR_NAME
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ZSSSFI0203_RGTOR  text
*      <--P_ZSSSFI0203_RGTOR_T  text
*----------------------------------------------------------------------*
FORM GET_RGTOR_NAME USING VALUE(P_RGTOR)
                    CHANGING CT_NAME.
  " 등록자명 취득
  DATA: LT_EMP TYPE TABLE OF ZTSSEMP,
        LS_EMP LIKE LINE OF LT_EMP.


  SELECT PERNR LNAME FNAME DEPID
    FROM ZTSSEMP
    INTO CORRESPONDING FIELDS OF TABLE LT_EMP.

  READ TABLE LT_EMP INTO LS_EMP WITH KEY PERNR = P_RGTOR.
  CT_NAME = LS_EMP-LNAME && LS_EMP-FNAME.

**  MOVE-CORRESPONDING LT_EMP TO GT_EMP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_JEH_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_JEH_DATA.

  SELECT JENUM FYEAR JTYPE STEXT CURKY RGDAT RGTOR
                REV RRSON RJNUM
    FROM ZTSSJEH
    INTO CORRESPONDING FIELDS OF TABLE GT_HDATA.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_DATA_0300
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GV_SUBRC  text
*----------------------------------------------------------------------*
FORM CHECK_DATA_0300  CHANGING PV_SUBRC.

  IF ZSSSFI0205-RGTOR IS INITIAL.

    MESSAGE S999(ZMCSS) WITH '등록자는 필수값입니다.' DISPLAY LIKE 'E'.
    PV_SUBRC = 4.
    RETURN.

  ELSEIF ZSSSFI0205-RGDAT IS INITIAL.

    MESSAGE S999(ZMCSS) WITH '등록일을 입력해 주세요.' DISPLAY LIKE 'E'.
    PV_SUBRC = 4.
    RETURN.

  ELSEIF ZSSSFI0205-RGDAT NE SY-DATUM.

    MESSAGE S999(ZMCSS) WITH '등록일은 ' SY-DATUM '입니다.' DISPLAY LIKE 'E'.
    PV_SUBRC = 4.
    RETURN.


  ELSEIF ZSSSFI0205-STEXT IS INITIAL.

    MESSAGE S999(ZMCSS) WITH '비고란을 입력해 주세요.' DISPLAY LIKE 'E'.
    PV_SUBRC = 4.
    RETURN.

  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_AP_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM INSERT_AP_DATA .
  " 반제전표 정보 입력 ZSSSFI0205

  MOVE-CORRESPONDING ZSSSFI0205 TO GS_ZTSSJEH.
  MOVE-CORRESPONDING GS_CIDATA TO GS_ZTSSJEI.

  " 헤더
  " 전표 번호 채번
  DATA: LV_NUM(6)   TYPE N,
        LV_NUM2(13) TYPE C.
  CALL FUNCTION 'NUMBER_GET_NEXT'
    EXPORTING
      NR_RANGE_NR             = '01'
      OBJECT                  = 'ZNRSSFI01'
      TOYEAR                  = SY-DATUM+0(4)
    IMPORTING
      NUMBER                  = LV_NUM
    EXCEPTIONS  " M TYPE -> A
      INTERVAL_NOT_FOUND      = 1
      NUMBER_RANGE_NOT_INTERN = 2
      OBJECT_NOT_FOUND        = 3
      QUANTITY_IS_0           = 4
      QUANTITY_IS_NOT_1       = 5
      INTERVAL_OVERFLOW       = 6
      BUFFER_OVERFLOW         = 7
      OTHERS                  = 8.
  IF SY-SUBRC = 0.
    LV_NUM2 = 'J' && SY-DATUM+0(4) && LV_NUM.
*    WRITE LV_NUM2.
  ENDIF.


  " 반제전표 헤더-라인 정보가 있을 경우만 인서트 되도록
  IF GT_CIDATA IS NOT INITIAL.
    IF ZSSSFI0206-DEBIT = ZSSSFI0206-CREDIT.

      GS_ZTSSJEH-JENUM = LV_NUM2.      " 전표번호 자동채번
      GS_ZTSSJEH-STEXT = ZSSSFI0205-STEXT.
      GS_ZTSSJEH-RGDAT = ZSSSFI0205-RGDAT.
      GS_ZTSSJEH-RGTOR = ZSSSFI0205-RGTOR.

      " 전표 헤더 정보 인서트
      INSERT ZTSSJEH FROM GS_ZTSSJEH.
      IF SY-SUBRC <> 0.
        ROLLBACK WORK.
        MESSAGE S999(ZMCSS) WITH '이미 존재하는 전표입니다.' DISPLAY LIKE 'E'.
      ELSE.
        LOOP AT GT_CIDATA INTO DATA(LV_ITEM).
          CLEAR GS_ZTSSJEI.
          MOVE-CORRESPONDING LV_ITEM TO GS_ZTSSJEI.
          GS_ZTSSJEI-JENUM = GS_ZTSSJEH-JENUM.
          GS_ZTSSJEI-FYEAR = GS_ZTSSJEH-FYEAR.
          INSERT ZTSSJEI FROM GS_ZTSSJEI.
          IF SY-SUBRC <> 0.
            ROLLBACK WORK.
            MESSAGE S999(ZMCSS) WITH '아이템 생성 오류' DISPLAY LIKE 'E'.
            EXIT.
          ENDIF.
        ENDLOOP.

        COMMIT WORK. " <-- LOOP 밖 (성공시 한 번만)
        MESSAGE S999(ZMCSS) WITH GS_ZTSSJEH-JENUM '지급 전표가 생성되었습니다'.

      ENDIF.
    ELSE.
      MESSAGE S999(ZMCSS) WITH '차변과 대변 금액이 일치하지 않습니다.' DISPLAY LIKE 'E'.
    ENDIF.
  ELSE.
    MESSAGE S999(ZMCSS) WITH '라인 아이템을 추가하세요.' DISPLAY LIKE 'E'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Module  MODIFY_SCREEN_0300  OUTPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE MODIFY_SCREEN_0300 OUTPUT.

  LOOP AT SCREEN.
    IF OK_CODE = 'BAP'.
      IF GV_FLAG2 = 'X'.
        IF SCREEN-GROUP1 = 'GR1'.
          SCREEN-INPUT = 0.
          GV_FLAG = 'X'.
        ENDIF.
      ENDIF.
      MODIFY SCREEN.
    ENDIF.
  ENDLOOP.


ENDMODULE.
*&---------------------------------------------------------------------*
*&      Form  CAL_SUM_DC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_ZSSSFI0104_DEBIT  text
*      <--P_ZSSSFI0104_CREDIT  text
*----------------------------------------------------------------------*
FORM CAL_SUM_DC CHANGING CV_DEBIT
                                                   CV_CREDIT.
  " 차/대변 총 금액
  DATA: LV_DEBIT  TYPE ZSSSFI0104-DEBIT,
        LV_CREDIT TYPE ZSSSFI0104-CREDIT.

  LOOP AT GT_ADATA INTO DATA(LS_ADATA).
    LV_DEBIT = LV_DEBIT + LS_ADATA-DEBIT.
    LV_CREDIT = LV_CREDIT + LS_ADATA-CREDIT.
  ENDLOOP.

  CV_DEBIT = LV_DEBIT.
  CV_CREDIT = LV_CREDIT.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_AP_INIT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_AP_INIT .

  " 헤더
  ZSSSFI0205-FYEAR = SY-DATUM+0(4).
  ZSSSFI0205-RGDAT = SY-DATUM.
  ZSSSFI0205-CURKY = 'KRW'.
  ZSSSFI0205-JTYPE = 'KZ'.

  IF ZSSSFI0203-RGTOR IS INITIAL AND ZSSSFI0203-RGTOR_T = 'AutoFIBot'.
    ZSSSFI0205-RGTOR = 'E0000001'.
    ZSSSFI0205-RGTOR_T = '최지예'.
  ELSE.
    ZSSSFI0205-RGTOR = 'E0000001'.
    ZSSSFI0205-RGTOR_T = '최지예'.
  ENDIF.

  IF ZSSSFI0203-STEXT IS NOT INITIAL.
    ZSSSFI0205-STEXT = ZSSSFI0203-STEXT.

    IF  ZSSSFI0205-STEXT CP '*IV'  OR ZSSSFI0205-STEXT CP 'IV*' .
      " 끝에 'IV'가 있으면 'AP'로 변경
      REPLACE ALL OCCURRENCES OF REGEX '\M*IV\M*' IN ZSSSFI0205-STEXT WITH 'AP'.

**      REPLACE REGEX 'IV' IN ZSSSFI0205-STEXT WITH 'AR'.
    ELSE.
      CONCATENATE 'AP' ZSSSFI0205-STEXT INTO ZSSSFI0205-STEXT SEPARATED BY ''..
*    ZSSSFI0205-STEXT = ZSSSFI0203-STEXT.
    ENDIF.

  ENDIF.




  " 아이템
  CLEAR GT_CIDATA.

  CLEAR GS_CIDATA.
  GS_CIDATA-JESEQ = '001'.
  GS_CIDATA-DEBIT = GS_MHDATA-TOPRC.
  GS_CIDATA-GLACC = '240000'.
  GS_CIDATA-ACTNM = '외상매입금'.
  GS_CIDATA-CURKY = 'KRW'.
  APPEND GS_CIDATA TO GT_CIDATA.

  CLEAR GS_CIDATA.
  GS_CIDATA-JESEQ = '002'.
  GS_CIDATA-CREDIT = GS_MHDATA-TOPRC.
  GS_CIDATA-GLACC = '110000'.
  GS_CIDATA-ACTNM = '은행'.
  GS_CIDATA-CURKY = 'KRW'.
  APPEND GS_CIDATA TO GT_CIDATA.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_RGTOR_DEPID
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ZSSSFI0101_RGTOR  text
*----------------------------------------------------------------------*
FORM CHECK_RGTOR_DEPID USING VALUE(P_RGTOR).

  " 등록자 조건: 회계부서 사원만 가능
  " select single 로 가져와서 체크

  IF P_RGTOR IS NOT INITIAL.

    DATA LV_DEPID TYPE C LENGTH 4.

    " ZSSSFI0102-RGTOR 값에 해당하는 사원의 부서를 찾음
    SELECT SINGLE DEPID
      INTO @LV_DEPID
      FROM ZTSSEMP
      WHERE PERNR = @P_RGTOR.

    " 해당되는 사원의 부서가 'D001'이 아닐 경우 에러
    IF SY-SUBRC = 0.
      IF LV_DEPID <> 'D001'.

        MESSAGE S999(ZMCSS) WITH '회계부서 사원만 가능합니다. ' DISPLAY LIKE 'E'.
        RETURN.

      ELSE.

*        MESSAGE S999(ZMCSS) WITH '회계부서 사원 확인 되었습니다. 라인 아이템을 추가하세요.'.
      ENDIF.

    ELSE.

      MESSAGE S999(ZMCSS) WITH '등록자 정보가 존재하지 않습니다.' DISPLAY LIKE 'E'.
      RETURN.

    ENDIF.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_MIVH_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_MIVH_DATA .

  SELECT *
    FROM ZTSSMIVH
    INTO CORRESPONDING FIELDS OF TABLE GT_MHDATA.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_DATA_0500
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_DATA_0500 .
  CLEAR ZSSSFI0203.

  " 청구 IV의 전표번호 헤더 정보 취득
  PERFORM GET_JEH_DATA.

  READ TABLE GT_HDATA INTO GS_HDATA WITH KEY JENUM = GS_SHDATA-JENUM.
  MOVE-CORRESPONDING GS_HDATA TO ZSSSFI0203.


  PERFORM GET_RGTOR_NAME USING ZSSSFI0203-RGTOR
                         CHANGING ZSSSFI0203-RGTOR_T.

  " 자동전표일 경우, 등록자명 AutoFIBot
  IF ZSSSFI0203-RGTOR IS INITIAL.
    ZSSSFI0203-RGTOR_T = 'AutoFIBot'.
  ENDIF.

  " 청구 IV의 라인아이템 정보 취득
  PERFORM GET_SJEI_DATA.

  " 청구 IV의 전표 차/대 분개 표시
  PERFORM CAL_SUM_DC CHANGING ZSSSFI0204-DEBIT
                              ZSSSFI0204-CREDIT.

  ZSSSFI0204-CURKY = ZSSSFI0203-CURKY.


  " 반제전표 생성(기본값)
  PERFORM SET_AR_INIT.

  PERFORM CAL_SUM_DC CHANGING ZSSSFI0206-DEBIT
                              ZSSSFI0206-CREDIT.

  ZSSSFI0206-CURKY = ZSSSFI0205-CURKY.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_FCAT_0600
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_FCAT_0600 .

  CLEAR: GT_FCAT.

  PERFORM FCAT USING:
        'JENUM' '1' '전표번호',
        'FYEAR' '2' '회계연도',
        'JESEQ' '3' '전표 아이템 번호',
        'DEBIT' '4' '차변',
        'CREDIT' '5' '대변',
        'CURKY' '6' '통화 키',
        'GLACC' '7' 'G/L 계정',
        'ACTNM' '8' 'G/L 계정명'.

  CLEAR GS_FCAT.

  LOOP AT GT_FCAT INTO GS_FCAT.
    IF GS_FCAT-FIELDNAME = 'JESEQ'.
      GS_FCAT-LZERO = 'X'.
    ELSEIF GS_FCAT-FIELDNAME = 'JENUM' OR GS_FCAT-FIELDNAME = 'FYEAR' .
      GS_FCAT-NO_OUT = 'X'.
    ELSEIF GS_FCAT-FIELDNAME = 'DEBIT' OR GS_FCAT-FIELDNAME = 'CREDIT'.
      GS_FCAT-CFIELDNAME = 'CURKY'.
    ENDIF.

    MODIFY GT_FCAT FROM GS_FCAT.
  ENDLOOP.


  CLEAR: GT_FCAT2.

  PERFORM FCAT2 USING:
        'JENUM' '1' '전표번호',
        'FYEAR' '2' '회계연도',
        'JESEQ' '3' '전표 아이템 번호',
        'DEBIT' '4' '차변',
        'CREDIT' '5' '대변',
        'CURKY' '6' '통화 키',
        'GLACC' '7' 'G/L 계정',
        'ACTNM' '8' 'G/L 계정명'.

  CLEAR GS_FCAT2.

  LOOP AT GT_FCAT2 INTO GS_FCAT2.
    IF GS_FCAT2-FIELDNAME = 'JESEQ'.
      GS_FCAT2-LZERO = 'X'.
    ELSEIF GS_FCAT2-FIELDNAME = 'JENUM' OR GS_FCAT2-FIELDNAME = 'FYEAR' .
      GS_FCAT2-NO_OUT = 'X'.
    ELSEIF GS_FCAT2-FIELDNAME = 'DEBIT' OR GS_FCAT2-FIELDNAME = 'CREDIT'.
      GS_FCAT2-CFIELDNAME = 'CURKY'.
    ENDIF.

    MODIFY GT_FCAT2 FROM GS_FCAT2.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CREATE_ALV_0600
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM CREATE_ALV_0600 .

  " 객체가 있을 시 미생성
  IF GO_CON5 IS NOT INITIAL.
    RETURN.
  ENDIF.

  CREATE OBJECT GO_CON5
    EXPORTING
      CONTAINER_NAME              = 'CON5'
    EXCEPTIONS
      CNTL_ERROR                  = 1
      CNTL_SYSTEM_ERROR           = 2
      CREATE_ERROR                = 3
      LIFETIME_ERROR              = 4
      LIFETIME_DYNPRO_DYNPRO_LINK = 5
      OTHERS                      = 6.
  IF SY-SUBRC <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*              WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CREATE OBJECT GO_ALV5
    EXPORTING
      I_PARENT          = GO_CON5
    EXCEPTIONS
      ERROR_CNTL_CREATE = 1
      ERROR_CNTL_INIT   = 2
      ERROR_CNTL_LINK   = 3
      ERROR_DP_CREATE   = 4
      OTHERS            = 5.
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.




  " 객체가 있을 시 미생성
  IF GO_CON6 IS NOT INITIAL.
    RETURN.
  ENDIF.

  CREATE OBJECT GO_CON6
    EXPORTING
      CONTAINER_NAME              = 'CON6'
    EXCEPTIONS
      CNTL_ERROR                  = 1
      CNTL_SYSTEM_ERROR           = 2
      CREATE_ERROR                = 3
      LIFETIME_ERROR              = 4
      LIFETIME_DYNPRO_DYNPRO_LINK = 5
      OTHERS                      = 6.
  IF SY-SUBRC <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*              WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CREATE OBJECT GO_ALV6
    EXPORTING
      I_PARENT          = GO_CON6
    EXCEPTIONS
      ERROR_CNTL_CREATE = 1
      ERROR_CNTL_INIT   = 2
      ERROR_CNTL_LINK   = 3
      ERROR_DP_CREATE   = 4
      OTHERS            = 5.
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV_0600
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM DISPLAY_ALV_0600 .

  CALL METHOD GO_ALV5->SET_TABLE_FOR_FIRST_DISPLAY
    EXPORTING
      IS_LAYOUT       = GS_LAYO
    CHANGING
      IT_OUTTAB       = GT_ADATA
      IT_FIELDCATALOG = GT_FCAT
      IT_SORT         = GT_SORT.
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.



  CALL METHOD GO_ALV6->SET_TABLE_FOR_FIRST_DISPLAY
    EXPORTING
      IS_LAYOUT       = GS_LAYO
    CHANGING
      IT_OUTTAB       = GT_CIDATA
      IT_FIELDCATALOG = GT_FCAT2
      IT_SORT         = GT_SORT.
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SEL_ROWS_0500
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SEL_ROWS_0500  CHANGING PV_SUBRC.

  " 행 선택 처리
  DATA: LV_LINE TYPE I.

  PERFORM GET_SELECTED_ROWS_0500 CHANGING GT_ROWS.

  DESCRIBE TABLE GT_ROWS LINES LV_LINE.
  CASE LV_LINE.
    WHEN '0'.
      MESSAGE S999(ZMCSS) WITH '수정할 데이터를 선택해주세요.' DISPLAY LIKE 'E'.
      PV_SUBRC = 4.
      RETURN.
    WHEN '1'.

      READ TABLE GT_ROWS INDEX 1 INTO GS_ROWS.

    WHEN OTHERS.
      MESSAGE S999(ZMCSS) WITH '데이터를 한 행만 선택하세요.' DISPLAY LIKE 'E'.
      PV_SUBRC = 4.
      RETURN.
  ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_SELECTED_ROWS_0500
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_ROWS  text
*----------------------------------------------------------------------*
FORM GET_SELECTED_ROWS_0500 CHANGING PT_ROWS TYPE LVC_T_ROW.

  CLEAR: PT_ROWS.

  CALL METHOD GO_ALV2->GET_SELECTED_ROWS
    IMPORTING
      ET_INDEX_ROWS = PT_ROWS.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_SIVH_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_SIVH_DATA .

  SELECT *
      FROM ZTSSSIVH
      INTO CORRESPONDING FIELDS OF TABLE GT_SHDATA.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_SJEI_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_SJEI_DATA .

  " 라인아이템 정보 취득
  SELECT JENUM FYEAR JESEQ DEBIT CREDIT CURKY GLACC
    FROM ZTSSJEI
    INTO CORRESPONDING FIELDS OF TABLE GT_ADATA
    WHERE JENUM = GS_SHDATA-JENUM
      AND FYEAR = GS_SHDATA-FYEAR.

  " G/L 계정명 취득
  LOOP AT GT_ADATA INTO GS_ADATA.
    PERFORM GET_GL_NAME USING GS_ADATA-GLACC
                        CHANGING GS_ADATA-ACTNM.

    MODIFY GT_ADATA FROM GS_ADATA.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_AR_INIT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_AR_INIT .

  " 헤더
  ZSSSFI0205-FYEAR = SY-DATUM+0(4).
  ZSSSFI0205-RGDAT = SY-DATUM.
  ZSSSFI0205-CURKY = 'KRW'.
  ZSSSFI0205-JTYPE = 'DZ'.

  IF ZSSSFI0203-RGTOR IS INITIAL AND ZSSSFI0203-RGTOR_T = 'AutoFIBot'.
    ZSSSFI0205-RGTOR = 'E0000001'.
    ZSSSFI0205-RGTOR_T = '최지예'.
  ELSE.
    ZSSSFI0205-RGTOR = 'E0000001'.
    ZSSSFI0205-RGTOR_T = '최지예'.
  ENDIF.


  IF ZSSSFI0203-STEXT IS NOT INITIAL.
    ZSSSFI0205-STEXT = ZSSSFI0203-STEXT.

    IF  ZSSSFI0205-STEXT CP '*IV'  OR ZSSSFI0205-STEXT CP 'IV*' .
      " 끝에 'IV'가 있으면 'AR'로 변경
      REPLACE ALL OCCURRENCES OF REGEX '\S*IV\S*' IN ZSSSFI0205-STEXT WITH 'AR'.

**      REPLACE REGEX 'IV' IN ZSSSFI0205-STEXT WITH 'AR'.
    ELSE.
      CONCATENATE 'AR' ZSSSFI0205-STEXT INTO ZSSSFI0205-STEXT SEPARATED BY ''..
*    ZSSSFI0205-STEXT = ZSSSFI0203-STEXT.
    ENDIF.

  ENDIF.

  " 아이템
  CLEAR GT_CIDATA.

  CLEAR GS_CIDATA.
  GS_CIDATA-JESEQ = '001'.
  GS_CIDATA-CREDIT = GS_SHDATA-TOPRC.
  GS_CIDATA-GLACC = '110000'.
  GS_CIDATA-ACTNM = '은행'.
  GS_CIDATA-CURKY = 'KRW'.
  APPEND GS_CIDATA TO GT_CIDATA.

  CLEAR GS_CIDATA.
  GS_CIDATA-JESEQ = '002'.
  GS_CIDATA-DEBIT = GS_SHDATA-TOPRC.
  GS_CIDATA-GLACC = '140000'.
  GS_CIDATA-ACTNM = '외상매출금'.
  GS_CIDATA-CURKY = 'KRW'.
  APPEND GS_CIDATA TO GT_CIDATA.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_DATA_0600
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GV_SUBRC  text
*----------------------------------------------------------------------*
FORM CHECK_DATA_0600  CHANGING PV_SUBRC.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INSERT_AR_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM INSERT_AR_DATA .
  " 반제전표 정보 입력 ZSSSFI0205

  MOVE-CORRESPONDING ZSSSFI0205 TO GS_ZTSSJEH.
  MOVE-CORRESPONDING GS_CIDATA TO GS_ZTSSJEI.

  " 헤더
  " 전표 번호 채번
  DATA: LV_NUM(6)   TYPE N,
        LV_NUM2(13) TYPE C.
  CALL FUNCTION 'NUMBER_GET_NEXT'
    EXPORTING
      NR_RANGE_NR             = '01'
      OBJECT                  = 'ZNRSSFI01'
      TOYEAR                  = SY-DATUM+0(4)
    IMPORTING
      NUMBER                  = LV_NUM
    EXCEPTIONS  " M TYPE -> A
      INTERVAL_NOT_FOUND      = 1
      NUMBER_RANGE_NOT_INTERN = 2
      OBJECT_NOT_FOUND        = 3
      QUANTITY_IS_0           = 4
      QUANTITY_IS_NOT_1       = 5
      INTERVAL_OVERFLOW       = 6
      BUFFER_OVERFLOW         = 7
      OTHERS                  = 8.
  IF SY-SUBRC = 0.
    LV_NUM2 = 'J' && SY-DATUM+0(4) && LV_NUM.
*    WRITE LV_NUM2.
  ENDIF.


  " 반제전표 헤더-라인 정보가 있을 경우만 인서트 되도록
  IF GT_CIDATA IS NOT INITIAL.
    IF ZSSSFI0206-DEBIT = ZSSSFI0206-CREDIT.

      GS_ZTSSJEH-JENUM = LV_NUM2.      " 전표번호 자동채번
      GS_ZTSSJEH-STEXT = ZSSSFI0205-STEXT.
      GS_ZTSSJEH-RGDAT = ZSSSFI0205-RGDAT.
      GS_ZTSSJEH-RGTOR = ZSSSFI0205-RGTOR.

      " 전표 헤더 정보 인서트
      INSERT ZTSSJEH FROM GS_ZTSSJEH.
      IF SY-SUBRC <> 0.
        ROLLBACK WORK.
        MESSAGE S999(ZMCSS) WITH '이미 존재하는 전표입니다.' DISPLAY LIKE 'E'.
      ELSE.
        LOOP AT GT_CIDATA INTO DATA(LV_ITEM).
          CLEAR GS_ZTSSJEI.
          MOVE-CORRESPONDING LV_ITEM TO GS_ZTSSJEI.
          GS_ZTSSJEI-JENUM = GS_ZTSSJEH-JENUM.
          GS_ZTSSJEI-FYEAR = GS_ZTSSJEH-FYEAR.
          INSERT ZTSSJEI FROM GS_ZTSSJEI.
          IF SY-SUBRC <> 0.
            ROLLBACK WORK.
            MESSAGE S999(ZMCSS) WITH '아이템 생성 오류' DISPLAY LIKE 'E'.
            EXIT.
          ENDIF.
        ENDLOOP.

        COMMIT WORK.
        MESSAGE S999(ZMCSS) WITH GS_ZTSSJEH-JENUM '수금 전표가 생성되었습니다'.

      ENDIF.
    ELSE.
      MESSAGE S999(ZMCSS) WITH '차변과 대변 금액이 일치하지 않습니다.' DISPLAY LIKE 'E'.
    ENDIF.
  ELSE.
    MESSAGE S999(ZMCSS) WITH '라인 아이템을 추가하세요.' DISPLAY LIKE 'E'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_RGTOR_INFO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GET_RGTOR_INFO .
  PERFORM GET_RGTOR_NAME USING ZSSSFI0205-RGTOR
                         CHANGING ZSSSFI0205-RGTOR_T.

  PERFORM CHECK_RGTOR_DEPID USING ZSSSFI0205-RGTOR.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_EVENT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_EVENT .

  CREATE OBJECT GO_EVENT.

  SET HANDLER:
  GO_EVENT->HANDLE_HOTSPOT_CLICK FOR GO_ALV.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  SET_EVENT2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM SET_EVENT2 .


  CREATE OBJECT GO_EVENT.

  SET HANDLER:
  GO_EVENT->HANDLE_HOTSPOT_CLICK FOR GO_ALV2.

ENDFORM.

----------------------------------------------------------------------------------
Extracted by Mass Download version 1.5.5 - E.G.Mellodew. 1998-2025. Sap Release 750
